{%extends 'c_base.tpl'%} {%$smarty.allow_php_tag=true%}{%block name="data_modifier"%} {%$extData.feData.hasShowURLGap = true%} {%$tplData.title=$tplData.titleDesc%} {%$tplData.url=$tplData.titleUrl%} {%function fe_fn_bus_tag_map tag=''%}{%$colors=['yellow', 'blue']%}{%$tempDataColor=$colors[1]%}{%if $tag=='路'%}{%$tempDataColor=$colors[1]%}{%/if%}{%$tempDataColor%}{%/function%} {%function fe_fn_bus_font_size_zoom str='' zoomMap=''%}{%$tempDataSize=13%}{%$strLength=preg_match_all("/./us", $str, $match)%}{%foreach $zoomMap as $item%}{%if $strLength<=$item@key%}{%$tempDataSize=$item%}{%break%}{%/if%}{%/foreach%}{%$tempDataSize%}{%/function%} {%function fe_fn_bus_font_size_zoom2 str='' zoomMap=''%}{%$tempDataSize=13%}{%$strLength=$str|string_display_len%}{%foreach $zoomMap as $item%}{%if $strLength<=$item@key%}{%$tempDataSize=$item%}{%break%}{%/if%}{%/foreach%}{%$tempDataSize%}{%/function%} {%$tempDataNumFontSizeZoomMap=['2'=> '60', '3'=> '46', '4'=> '36', '5'=> '30', '6'=> '26', '7'=> '20', '8'=> '16', '9'=> '14']%} {%$tempDataStartEndFontSizeZoomMap=['11'=> '24', '12'=> '22', '13'=> '20', '14'=> '18', '15'=> '17', '16'=> '16', '17'=> '15', '18'=> '14', '19'=> '13', '20'=> '13']%}{%*模板全局配置*%}{%*换乘线宽度*%}{%*间隔支撑块高度*%}{%*是否有分叉线路*%}{%$tplData.config=[
	'transferLineWidth' => 6,
	'middleSeperatorHeight' => 70,
	'lineBoxHeight' => 128,
	'hasCross' => ($tplData.lines[1] && count($tplData.lines[1])>0)
]%}{%if $tplData.config.hasCross%}{%$tplData.config.middleSeperatorHeight=40%}{%*
{%$cross1Start=$tplData.lines[0][0]['stopInfo'][0]['stopName']%}
{%$cross1End=end($tplData.lines[0][0]['stopInfo'])%}
{%$cross2Start=$tplData.lines[1][0]['stopInfo'][0]['stopName']%}
{%$cross2End=end($tplData.lines[1][0]['stopInfo'])%}
{%$arr=[$cross1Start, $cross1End['stopName'], $cross2Start, $cross2End['stopName']]%}
{%$repeat=[]%}
{%$repeatStop=''%}
{%foreach $arr as $item%}
	{%if $repeat[ord($item)]%}
		{%$repeatStop=$item%}
		{%break%}
	{%else%}
		{%$repeat[ord($item)]='true'%}
	{%/if%}
{%/foreach%}
*%}{%/if%}{%/block%}{%block name='content'%}{%*var_dump($tplData.lines)*%}{%*
正:<br>
{%foreach $tplData.lines[0][0]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
{%foreach $tplData.lines[1][0]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
反:<br>
{%foreach $tplData.lines[0][1]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
{%foreach $tplData.lines[1][1]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
*%}<div class="op-map-subway-content" style="height:{%if $tplData.config.hasCross%}{%136+2+10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+10+2+40%}{%else%}{%110+2+10+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+10+2%}{%/if%}px;" data-citycode="{%$tplData.cityCode|escape%}"> <div class="op-map-subway-content-inner"> {%foreach $tplData.lines[0] as $item%}{%*分叉开始索引*%}{%$tempDataCross1Index=0%}{%$tempDataCross2Index=0%}{%*分叉方向*%}{%$tempDataCrossDirection='right'%}{%*主线站点集合*%}{%$tempDataCross1Stops=$item['stopInfo']%}{%*站点容器宽度buffer*%}{%$tempDataContainerWidthBuffer=14%}{%*站点容器宽度*%}{%$tempDataContainerWidth=count($tempDataCross1Stops)*34-14+$tempDataContainerWidthBuffer%}{%if $tplData.config.hasCross%}{%*辅线站点集合*%}{%$tempDataCross2Stops=$tplData.lines[1][$item@index]['stopInfo']%}{%*若两条分叉线路的第一站站名不相同，则表示分叉向左*%}{%if $tempDataCross1Stops[0]['stopName'] != $tempDataCross2Stops[0]['stopName']%}{%$tempDataCrossDirection='left'%}{%/if%}{%*正向(右)时计算分叉点*%}{%if $tempDataCrossDirection=='right'%}{%foreach $tempDataCross1Stops as $item1%}{%$tempDataCross2StopName=$tempDataCross2Stops[$item1@index]['stopName']%} {%if $item1['stopName'] != $tempDataCross2StopName%}{%$tempDataCross1Index=$item1@index%}{%$tempDataCross2Index=$item1@index%}{%*$tempDataContainerWidth=(count(array_slice($tempDataCross1Stops, 0, $tempDataCross1Index+1))+count(array_slice($tempDataCross2Stops, $tempDataCross2Index+1)))*34-14+$tempDataContainerWidthBuffer*%}{%break%}{%/if%}{%/foreach%}{%/if%}{%*反向(左)时计算分叉点*%}{%if $tempDataCrossDirection=='left'%}{%$tempDataFoundFlag=false%}{%foreach $tempDataCross1Stops as $item1%}{%foreach $tempDataCross2Stops as $item2%} {%if $item1['stopName'] == $item2['stopName']%}{%$tempDataCross1Index=$item1@index%}{%$tempDataCross2Index=$item2@index%}{%$tempDataFoundFlag=true%}{%/if%}{%/foreach%}{%if $tempDataFoundFlag==true%}{%break%}{%/if%}{%/foreach%} {%/if%}{%*站点容器宽度*%}{%if count($tempDataCross2Stops)>count($tempDataCross1Stops)%}{%$tempDataContainerWidth=count($tempDataCross2Stops)*34-14+$tempDataContainerWidthBuffer%}{%/if%}{%*主线交叉路段有无换乘*%}{%foreach $tempDataCross1Stops as $itemInner%}{%if $itemInner@index>$tempDataCross1Index && $itemInner.transfer && count($itemInner.transfer)>0%}{%$tempDataCross1HasTransfer=true%}{%/if%}{%/foreach%}{%*辅线交叉路段有无换乘*%}{%foreach $tempDataCross2Stops as $itemInner%}{%if $itemInner@index>$tempDataCross1Index && $itemInner.transfer && count($itemInner.transfer)>0%}{%$tempDataCross2HasTransfer=true%}{%/if%}{%/foreach%}{%*根据主辅交叉路段有无换乘决定间隔支撑块高度*%}{%*
			{%if $tempDataCross1HasTransfer && $tempDataCross2HasTransfer%}
				{%$tplData.config.middleSeperatorHeight=50%}
			{%else%}
				{%$tplData.config.middleSeperatorHeight=34%}
			{%/if%}
			*%}{%/if%} <div class="op-map-subway-flip-board{%if $item@index==1%} op-map-subway-content-back{%/if%}" style="z-index:{%10-$item@index%};{%if $item@index>0%}*display:none;{%/if%}" data-line-color="{%$item['lineColor']|escape%}" data-zindex-toggle="{%10-(1-$item@index)%}"> <table class="op-map-subway-info"> <tr> {%if $item.busName1||$item.busName2%} <td class="op-map-subway-info-left"{%*{%if $tplData.config.hasCross%} style="padding-top:20px;"{%/if%}*%}>{%$tempDataBusName1FontSize={%fe_fn_bus_font_size_zoom2 str=$item.busName1 zoomMap=$tempDataNumFontSizeZoomMap%}%} <div class="op-map-subway-info-num" style="font-size:{%$tempDataBusName1FontSize%}px;line-height:{%$tempDataBusName1FontSize%}px;height:{%$tempDataBusName1FontSize%}px;">{%$item.busName1|escape%}</div>{%$tempDataBusName2Length=$item.busName2|string_display_len%} <div{%if $tempDataBusName2Length>8%} title="{%$item.busName1|cat:$item.busName2|escape%}"{%/if%} class="op-map-subway-info-tag {%if $item.busName2 && trim($item.busName2)%}op-map-subway-info-tag-{%fe_fn_bus_tag_map tag=$item.busName2%}{%/if%}">{%$item.busName2|limitlen:8|escape%}</div> </td> {%/if%} <td class="op-map-subway-info-right"> <div class="op-map-subway-info-right-container"> <table class="op-map-subway-info-start-end"{%if $tplData.config.hasCross%} style="height:44px;"{%/if%}> <tr> {%if $tplData.config.hasCross%} <td class="op-map-subway-info-start">{%if $tempDataCrossDirection=='left'%}<div style="font-size:16px;line-height:16px;margin-bottom:10px;">{%$item.startName|escape%}</div><div style="font-size:16px;line-height:16px;">{%$tplData.lines[1][$item@index].startName|escape%}</div>{%else%}<div style="font-size:20px;line-height:42px;">{%$item.startName|escape%}</div>{%/if%}</td> <td class="op-map-subway-info-direction op-map-subway-info-cross-direction-{%$tempDataCrossDirection%}">&nbsp;</td> <td class="op-map-subway-info-end">{%if $tempDataCrossDirection=='right'%}<div style="font-size:16px;line-height:16px;margin-bottom:10px;">{%$item.endName|escape%}</div><div style="font-size:16px;line-height:16px;">{%$tplData.lines[1][$item@index].endName|escape%}</div>{%else%}<div style="font-size:20px;line-height:42px;">{%$item.endName|escape%}</div>{%/if%}</td> {%else%} {%$tempDataStartEndFontSize={%fe_fn_bus_font_size_zoom str=$item.startName|cat:$item.endName zoomMap=$tempDataStartEndFontSizeZoomMap%}%} <td class="op-map-subway-info-start" style="font-size:{%$tempDataStartEndFontSize%}px;line-height:{%if $tempDataStartEndFontSize<20%}20{%else%}{%$tempDataStartEndFontSize%}{%/if%}px;">{%$item.startName|escape%}</td> <td class="op-map-subway-info-direction">&nbsp;</td> <td class="op-map-subway-info-end" style="font-size:{%$tempDataStartEndFontSize%}px;line-height:{%if $tempDataStartEndFontSize<20%}20{%else%}{%$tempDataStartEndFontSize%}{%/if%}px;">{%$item.endName|escape%}</td> {%/if%} </tr> </table> <div class="op-map-subway-info-info"> {%if $tplData.config.hasCross%} <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$item.startTime|escape%}</span> <span class="op-map-subway-info-endtime">末车：{%$item.endTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$tplData.lines[1][$item@index].startTime|escape%}</span> <span class="op-map-subway-info-endtime">末车：{%$tplData.lines[1][$item@index].endTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-price">票价：{%if $item.priceNum<$tplData.lines[1][$item@index].priceNum%}{%$tplData.lines[1][$item@index].price%}{%else%}{%$item.price|escape%}{%/if%}</span> </div> {%else%} <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$item.startTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-endtime">末车：{%$item.endTime|escape%}</span> <span class="op-map-subway-info-price">票价：{%$item.price|escape%}</span> </div> {%/if%} </div> {%if $item|count > 1%} <div class="op-map-subway-info-switcher-border"></div><div class="op-map-subway-info-switcher OP_LOG_BTN" data-click="{fm:'beha'}">返程</div> {%/if%} <a href="{%$item.lineUrl%}" target="_blank" class="op-map-subway-info-link">在地图上显示路线</a> </div> </td> </tr> </table> <div class="op-map-subway-station-container"> <table class="op-map-subway-station-layout"> <tr> <td class="op-map-subway-station-toucher op-map-subway-station-prev op-map-subway-station-prev-disable" data-direction="1"{%if count($tempDataCross1Stops)>14 || ($tplData.config.hasCross && count($tempDataCross2Stops)>14)%}{%else%} style="visibility:hidden;"{%/if%}> <div style="margin-top:{%if $tplData.config.hasCross%}{%10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+10-24/2%}{%else%}{%10+$tplData.config.middleSeperatorHeight+10-24/2%}{%/if%}px;"></div> </td> <style></style> <td> <div class="op-map-subway-station" style="height:{%if $tplData.config.hasCross%}{%$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+40%}{%else%}{%$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight%}{%/if%}px;"> <div class="op-map-subway-station-inner" style="width:{%$tempDataContainerWidth%}px;left:0;padding:0 3px;"> {%if $tplData.config.hasCross%} <div class="op-map-subway-line op-map-subway-line2"> <div class="op-map-subway-line-stop-container c-clearfix"> {%$tempDataCross1MarginLeft=0%} {%$tempDataCross2MarginLeft=0%} {%if $tempDataCrossDirection=='right'%} {%*删掉辅线重叠站点*%} {%$tempDataCross2Stops=array_slice($tempDataCross2Stops, $tempDataCross2Index)%} {%$tempDataCross2MarginLeft=$tempDataCross1Index*34%} {%$tempDataCross2BlockLeft=$tempDataCross2MarginLeft-10-14%} {%$tempDataCross2LineWidth=(count($tempDataCross2Stops)-1)*34%} {%else%} {%*删掉辅线重叠站点*%}{%*var_dump($tempDataCross2Index)*%} {%$tempDataCross2Stops=array_slice($tempDataCross2Stops, 0, $tempDataCross2Index)%} {%if $tempDataCross2Index<=$tempDataCross1Index%} {%$tempDataCross2MarginLeft=($tempDataCross1Index-$tempDataCross2Index)*34%}{%else%} {%$tempDataCross2MarginLeft=0%} {%$tempDataCross1MarginLeft=($tempDataCross2Index-$tempDataCross1Index)*34%} {%/if%} {%$tempDataCross2BlockLeft=$tempDataCross2MarginLeft+(count($tempDataCross2Stops)-1)*34+10%} {%$tempDataCross2LineWidth=(count($tempDataCross2Stops)-1)*34%} {%/if%} {%foreach $tempDataCross2Stops as $itemInner%} <div class="op-map-subway-line-stop" style="{%if $itemInner@first%}margin-left:{%$tempDataCross2MarginLeft%}px;{%/if%}margin-right:{%if $itemInner@last%}0{%else%}8{%/if%}px;"> {%$tempDataHasTranfer=false%} {%if $itemInner.transfer && count($itemInner.transfer)>0%} {%$tempDataHasTranfer=true%} {%/if%} {%if $tempDataHasTranfer%} <div class="op-map-subway-line-stop-transfer-info" style="top:150px;height:auto;width:auto;white-space:nowrap;"> <div class="op-map-subway-line-stop-transfer-info-text"></div> </div> <div class="op-map-subway-line-stop-transfer-line-box"> <div class="op-map-subway-line-stop-transfer-line-box-inner c-clearfix" style="width:{%count($itemInner.transfer)*$tplData.config.transferLineWidth%}px;"> {%foreach $itemInner.transfer as $itemTransfer%} <div class="op-map-subway-line-stop-transfer-line" data-name="{%$itemTransfer.name|escape%}" style="background-color:{%$itemTransfer.lineColor|escape%}"></div> {%/foreach%} </div> </div> {%/if%} <div class="op-map-subway-line-stop-info"> <a href="{%$itemInner.stopUrl%}" target="_blank" hidefocus="true"{%if $itemInner.stopName|string_display_len>10%} title="{%$itemInner.stopName|escape%}"{%/if%}> <span class="op-map-subway-line-stop-info-text">{%if strpos($itemInner.stopName, '航站楼')!=false%}<span class="op-map-subway-icon op-map-subway-icon-flight"></span>{%/if%}{%str_replace('...','…',$itemInner.stopName|limitlen:12)|escape%}</span> </a> </div> <div class="op-map-subway-line-stop-icon"{%if $tempDataHasTranfer%} data-transfer="true"{%/if%}> <div class="op-map-subway-line-stop-icon-canvas-container"></div> <div class="op-map-subway-line-stop-icon-text">{%if $tempDataHasTranfer%}<div data-stop="{%$itemInner.stopName|escape%}" data-uid="{%$itemInner.uid|escape%}"></div>{%else%}{%$itemInner.stopNo|escape%}{%/if%}</div> </div> </div> {%/foreach%} </div> <div class="op-map-subway-line-line" style="bottom:7px;left:{%$tempDataCross2MarginLeft+10%}px;width:{%$tempDataCross2LineWidth%}px;background-color:{%$item['lineColor']|escape%}"></div> <div class="op-map-subway-line-slash-canvas-container" data-direction="{%$tempDataCrossDirection%}" style="top:{%$tplData.config.lineBoxHeight-10%}px;left:{%$tempDataCross2BlockLeft%}px;height:{%10+10+$tplData.config.middleSeperatorHeight%}px;"></div> </div> {%/if%} <div class="op-map-subway-line-middle-seperator" style="height:{%$tplData.config.middleSeperatorHeight%}px;"></div> <div class="op-map-subway-line op-map-subway-line1"> <div class="op-map-subway-line-stop-container c-clearfix"> {%foreach $tempDataCross1Stops as $itemInner%} <div class="op-map-subway-line-stop" style="{%if $itemInner@first%}margin-left:{%$tempDataCross1MarginLeft%}px;{%/if%}margin-right:{%if $itemInner@last%}0{%else%}8{%/if%}px;"> {%$tempDataHasTranfer=false%} {%if $itemInner.transfer && count($itemInner.transfer)>0%} {%$tempDataHasTranfer=true%} {%/if%} {%if $tempDataHasTranfer%} <div class="op-map-subway-line-stop-transfer-info" {%if $tplData.config.hasCross%}{%if ($tempDataCrossDirection=='right'&&$itemInner@index>=$tempDataCross1Index) || ($tempDataCrossDirection=='left'&&$itemInner@index<=$tempDataCross1Index)%}style="width:auto;height:auto;white-space:nowrap;"{%/if%}{%/if%}> <div class="op-map-subway-line-stop-transfer-info-text"></div> </div> <div class="op-map-subway-line-stop-transfer-line-box"> <div class="op-map-subway-line-stop-transfer-line-box-inner c-clearfix" style="width:{%count($itemInner.transfer)*$tplData.config.transferLineWidth%}px;"> {%foreach $itemInner.transfer as $itemTransfer%} <div class="op-map-subway-line-stop-transfer-line" data-name="{%$itemTransfer.name|escape%}" style="background-color:{%$itemTransfer.lineColor|escape%}"></div> {%/foreach%} </div> </div> {%/if%} <div class="op-map-subway-line-stop-icon"{%if $tempDataHasTranfer%} data-transfer="true"{%/if%}> <div class="op-map-subway-line-stop-icon-canvas-container"></div> <div class="op-map-subway-line-stop-icon-text">{%if $tempDataHasTranfer%}<div data-stop="{%$itemInner.stopName|escape%}" data-uid="{%$itemInner.uid|escape%}"></div>{%else%}{%$itemInner.stopNo|escape%}{%/if%}</div> </div> <div class="op-map-subway-line-stop-info"> <a href="{%$itemInner.stopUrl%}" target="_blank" hidefocus="true"{%if $itemInner.stopName|string_display_len>10%} title="{%$itemInner.stopName|escape%}"{%/if%}> <span class="op-map-subway-line-stop-info-text">{%str_replace('...','…',$itemInner.stopName|limitlen:12)|escape%}{%if preg_match('/(机场|航站楼)$/', $itemInner.stopName) > 0%}<span class="op-map-subway-icon op-map-subway-icon-flight"></span>{%/if%}</span> </a> </div> </div> {%/foreach%} </div> <div class="op-map-subway-line-line" style="top:7px;left:{%$tempDataCross1MarginLeft+10%}px;width:{%(count($tempDataCross1Stops)-1)*34%}px;background-color:{%$item['lineColor']|escape%}"></div> </div>{%if $tplData.config.hasCross%} <div style="height:40px;">&nbsp;</div> {%/if%} </div> </div> </td> <td class="op-map-subway-station-toucher op-map-subway-station-next" data-direction="-1"{%if count($tempDataCross1Stops)>14 || ($tplData.config.hasCross && count($tempDataCross2Stops)>14)%}{%else%} style="visibility:hidden;"{%/if%}> <div style="margin-top:{%if $tplData.config.hasCross%}{%10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+10-24/2%}{%else%}{%10+$tplData.config.middleSeperatorHeight+10-24/2%}{%/if%}px;"></div> </td> </tr> </table><style></style> </div> </div> {%/foreach%} </div></div><script>A.setup({middleSeperatorHeight:parseInt('{%$tplData.config.middleSeperatorHeight%}')});</script>{%/block%}
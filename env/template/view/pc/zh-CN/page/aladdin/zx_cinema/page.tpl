{%extends 'c_base.tpl'%} {%block name='data_modifier'%} {%$extData.feData.hasShowURLGap=true%}{%$tplData.showurl = 'tuan.baidu.com/movie'%}{%/block%}{%block name="title"%}{%/block%}{%block name='content'%}{%$tmpData.condition = json_decode($tplData.otherinfo, true)%}{%$tmpData.weekarray=array("日","一","二","三","四","五","六")%}{%$alias = array_diff($tplData.QueryTags, [$tplData.result[0].city])%}{%foreach $alias as $item%}{%$alias = $item%}{%/foreach%}{%if $tplData.result[0].displayTitle != $alias && $alias %}{%$alias="(<em>`$alias|escape:html`</em>)"%}{%else%}{%$alias=""%}{%/if%}{%$titleLen = (strlen($tplData.alias) + mb_strlen($tplData.alias,'utf-8'))/2%}{%$titleTail = "_影讯_选座_团购_百度电影购票"%}{%if $titleLen < 74%}{%$titleTail = $titleTail|limitlen:(74-$titleLen)%}{%else%}{%$titleTail = ""%}{%/if%}{%$tplData.title = $tplData.result[0].displayTitle|cat:$titleTail%}<div class="op_zx_cinema"> <h3><a class="op_zx_cinema_mainlink OP_LOG_LINK" target="_blank" href="{%$tplData.result[0].city_allurl%}" >{%$tplData.result[0].displayTitle|escape:html|highlight:0|cat:$alias|cat:$titleTail%}</a></h3> <div class="c-border"> <div class="op_zx_cinema_condi_main"> <table class="op_zx_cinema_condition" cellpadding="0" cellspacing="0" width="100%" data-click="{'fm':'beha'}"> <tr style="display:none;"> <td width="35"><b>来源:</b></td> <td class="op_zx_cinema_from"> {%foreach $tmpData.condition.source as $site%} <a href="#" onclick="return false;" hidefocus="hideFocus"{%if $site.k == $tplData.result[0].source%} class="op_zx_cinema_select"{%$tmpData.siteIndex=$site@index%}{%/if%}>{%$site.k|escape:html%}</a>{%if !$site@last %}|{%/if%} {%if $site.hasSubCate%} {%for $i=0 to $site.date|count -2%} {%for $j=$i+1 to $site.date|count -1%} {%if $site.date[$i].k >= $site.date[$j].k%} {%$tmpData.midDate = $tmpData.condition.source[$site@index].date[$j]%} {%$tmpData.condition.source[$site@index].date[$j] = $tmpData.condition.source[$site@index].date[$i]%} {%$tmpData.condition.source[$site@index].date[$i] = $tmpData.midDate%} {%$tmpData.midDate = $site.date[$j]%} {%$site.date[$j] = $site.date[$i]%} {%$site.date[$i] = $tmpData.midDate%} {%/if%} {%/for%} {%/for%} {%foreach $site.date as $dateItem%} {%if $dateItem && !in_array($dateItem.k, $tmpData.dateArray)%} {%$tmpData.dateArray[] = $dateItem.k%} {%/if%} {%/foreach%} {%/if%} {%/foreach%} {%$tmpData.sortDate = sort($tmpData.dateArray)%} {%$tplData.otherinfo = json_encode($tmpData.condition)%} </td> <td></td> </tr> <tr> <td width="40" style="padding-top:2px;color:#333">日期：</td> <td class="op_zx_cinema_date"> {%foreach $tmpData.dateArray as $dateItem%} {%$tmpData.dateTmp = date("m.d", strtotime($dateItem))%} {%$tmpData.weekTmp = $tmpData.weekarray[date("w",strtotime($dateItem))]%} <a href="#" onclick="return false;" hidefocus="hideFocus" data-key="{%$dateItem|escape:html%}"
                    {%$tmpData.dateFlag = 1%}
                    {%foreach $tmpData.condition.source[$tmpData.siteIndex].date as $dateTemp%}
                        {%if $dateTemp.k == $dateItem %}
                            {%$tmpData.dateFlag = 0%}
                            {%if $dateTemp@first%}
                            class="op_zx_cinema_select"
                            {%/if%}
                        {%/if%}
                    {%/foreach%}
                    {%if $tmpData.dateFlag%}
                        class="op_zx_cinema_noselect"
                    {%/if%}
                >{%$tmpData.dateTmp|escape:html%}周{%$tmpData.weekTmp|escape:html%}</a> {%/foreach%} </td> <td></td> </tr> <tr> <td width="40" valign="top" style="padding-top:5px;color:#333"">地区：</td> <td class="op_zx_cinema_area"> <a href="#" onclick="return false;" hidefocus="hideFocus" class="op_zx_cinema_select" data-key="全部">{%$tplData.result[0].city%}全部</a> {%$tmpData.areaArray = array()%} {%$tmpData.areaTrue = array()%} {%foreach $tmpData.condition.area_stat as $areaItem%} {%$tmpData.areaArray[] = $areaItem.k%} {%/foreach%} {%foreach $tmpData.condition.source[$tmpData.siteIndex].date[0].area as $areaItem%} {%$tmpData.areaTrue[] = $areaItem.k%} {%/foreach%} {%foreach $tmpData.areaArray as $areaItem%} <a href="#" onclick="return false;"  hidefocus="hideFocus"{%if !in_array($areaItem, $tmpData.areaTrue)%} class="op_zx_cinema_noselect"{%/if%}{%if $areaItem@index > 4%} style="display:none;"{%/if%} data-key="{%$areaItem|escape:html%}">{%$areaItem|escape:html%} </a> {%/foreach%} </td> <td valign="top"{%if $tmpData.condition.area_stat|count>6%} width="45" style="padding-top:4px;"{%/if%}>{%if $tmpData.condition.area_stat|count>6%}<span class="op_zx_cinema_open OP_LOG_BTN">展开<b></b></span><span class="op_zx_cinema_close OP_LOG_BTN" style="display:none;">收起<b></b></span>{%/if%}</td> </tr> </table> </div> <ul class="op_zx_cinema_info op_zx_cinema_clearfix"> </ul> <div class="op_zx_cinema_load" style="display:none;"> <table style="height:100%;margin:auto;"><tbody><tr><td><div>正在努力为您加载...</div></td></tr></tbody></table> </div> <div class="op_zx_cinema_noresult" style="display:none;"> <table style="height:100%;margin:auto;"><tbody><tr><td><div>抱歉，您选择的时间和地区暂无上映信息！</div></td></tr></tbody></table> </div> <div class="op_zx_cinema_request2" style="display:none;"> <table style={%*i*%}"height:100%;margin:auto;"><tbody><tr><td><div>抱歉，网络发生错误，<a href="#" onclick="return false;">请刷新</a></div></td></tr></tbody></table> </div> </div></div><script >
    A.setup({"condi":{%$tplData.otherinfo%},"listNum":"{%$tmpData.condition.source[0].date[0].v|escape:'javascript'%}","dateArr":{%json_encode($tmpData.dateArray)%},"city":"{%$tplData.result[0].city|escape:javascript%}","sid":{%$extData.resourceid%},"ip":"{%$queryInfo.pUrlConfig.ip|escape:javascript%}","query":"{%str_replace($extData.resourceid|cat:'_','',$extData.fetchkey)|escape:'javascript'%}","cnt":[{%foreach $tplData.result as $item%}{"cinema":"{%$item.cinema|escape:javascript%}","cinemaname":"{%$item.cinemaname|escape:javascript%}","cinemaurl":"{%$item.cinemaurl|escape:javascript%}","time":"{%$item.time|escape:javascript%}","ticket":"{%$item.ticket|escape:javascript%}","allnum":"{%$item.allnum|escape:javascript%}","allink":"{%$item.allink|escape:javascript%}","city_allurl":"{%$item.city_allurl|escape:javascript%}"},{%/foreach%}{}]});
</script><script>A.setup(function(){var _this = this,$mainlink = _this.find('.op_zx_cinema_mainlink').eq(0),$condDom = _this.find('.op_zx_cinema_condition').eq(0),$fromDom = _this.find('.op_zx_cinema_from').eq(0),$dateDom = _this.find('.op_zx_cinema_date').eq(0),$areaDom = _this.find('.op_zx_cinema_area').eq(0),$info = _this.find('.op_zx_cinema_info').eq(0),$loadDom = _this.find('.op_zx_cinema_load').eq(0),$request2 = _this.find('.op_zx_cinema_request2').eq(0),$requesta = $request2.find('a').eq({%*i*%}0),$noDom = _this.find('.op_zx_cinema_noresult').eq(0),$open = _this.find('.op_zx_cinema_open').eq(0),$close = _this.find('.op_zx_cinema_close').eq(0),siteIndex = 0,ajaxCnt = 0,loadOut;_this.data.cnt.pop(); var ajaxFinished = false;var initData = _this.data.cnt;buildHtml(initData,_this.data.listNum);if ($open.length>0) {$open.on('click', function(){$areaDom.find('a').each(function(index,e){if (index > 5) {e.style.display = '';}});$open.css('display','none');$close.css('display','');});$open.hove{%*i*%}r(function(){$open.addClass('op_zx_cinema_oc_hover');},function(){$open.removeClass('op_zx_cinema_oc_hover');});}if ($close.length>0) {$close.on('click', function(){$areaDom.find('a').each(function(index,e){if (index > 5) {e.style.display = 'none';}});$open.css('display','');$close.css('display','none');});$close.hover(function(){$close.addClass('op_zx_cinema_oc_hover');},function(){$close.removeClass('op_zx_cinema_oc_hover');});}$fromDom.find('a').on('click',function(){siteIndex = $fromDom.find{%*i*%}('a').index(this);modSite(siteIndex); modTag($(this));});$dateDom.find('a').on('click',function(){modDate($(this).attr('data-key'));modTag($(this));});$areaDom.find('a').on('click',function(){modDate($(this).attr('data-key'));modTag($(this));});$requesta.on('click', getInfo);function getInfo(){var dateinfo = $dateDom.find('.op_zx_cinema_select').eq(0).attr('data-key') || '',source = $fromDom.find('.op_zx_cinema_select').eq(0).html() || '',area = $areaDom.find('.op_zx_cinema_select').eq(0).attr('{%*i*%}data-key') || '',now = new Date(parseInt(bds.comm.serverTime + '000',10)),tomm = new Date(now.getTime() + 86400000),time_extend = bds.comm.serverTime + '_'+ tomm.getTime().toString().substring(0,10);area = area == '全部'?'':area;if (formatDate(now, 'yyyy-MM-dd') != dateinfo) {time_extend = '';}var url = 'http://opendata.baidu.com/api.php?resource_id=#{0}&query=#{1}&source=#{2}&date=#{3}&curtime_extend=#{4}&area=#{5}&city=#{6}&from_mid=1&format=json&oe=utf-8';if (_this.data.ip){url += '&ip=' + _thi{%*i*%}s.data.ip;} $.ajax({url:$.format(url, _this.data.sid, encodeURIComponent(_this.data.query), encodeURIComponent(source), dateinfo, time_extend, encodeURIComponent(area), encodeURIComponent(_this.data.city)),dataType:"jsonp",jsonp:"cb",timeout:6000,scriptCharset:"utf-8",success: function(data){if(ajaxFinished) return;buildHtml(data.data[0].disp_data,data.data[0].listNum,area);ajaxCnt--;if (loadOut) {clearTimeout(loadOut);loadOut = 0;} if (!ajaxCnt) {if (parseInt(data.data[0].listNum) == 0 || data.{%*i*%}data[0].disp_data.length<1) {$noDom.css('display','');$info.css('display','none');$loadDom.css('display','none');$request2.css('display','none');} else {$noDom.css('display','none');$info.css('display','');$loadDom.css('display','none');$request2.css('display','none');}}},error: function(){ajaxCnt--;if (!ajaxCnt && $request2.css('display') == "none") {$noDom.css('display','none');$info.css('display','none');$loadDom.css('display','none');$request2.css('display','');}}});ajaxCnt++;if ( $loadDom.c{%*i*%}ss('display') == "none") {loadOut = setTimeout(function(){$noDom.css('display','none');$info.css('display','none');$loadDom.css('display','');$request2.css('display','none');},1000);} }function buildHtml(data,listNum,area){var len = data.length,allink,html = [];for(var i = 0; i < len && i < 3 && i < listNum; i++) {if(!i) {html.push('<li class="op_zx_cinema_noborder c-clearfix">');} else {html.push('<li class="c-clearfix">');}html.push(buildInfoHtml(data[i]));html.push('</li>');};if (area) {allin{%*i*%}k=(data[0]?data[0].allink:'');} else {allink=(data[0]?data[0].city_allurl:'');}if (len > 2 && listNum > 3 && data[0].allink != '') {html = html.concat(['<li class="op_zx_cinema_morelink c-clearfix"><a target="_blank" style="float:left;" href="',allink,'">去查看全部',listNum,'家影院<label style="font-family:simsun">&gt;&gt;</label></a></li>']);}$mainlink.attr('href',allink);$info.html(html.join(''));}function buildInfoHtml(htmlData){ var html = ['<div class="op_zx_cinema_subtitle"><a target="_blank" href{%*i*%}="',htmlData.cinemaurl,'" title="',htmlData.cinemaname,'">',limitLen(htmlData.cinema, 24),'</a>'];if (htmlData.ticket == 2 || htmlData.ticket == 3) {html.push('<b></b>');}html = html.concat(['</div><div class="op_zx_cinema_time">', dealTime(htmlData.time), '</div>']);switch (htmlData.ticket) {case "1" :case "3" :html = html.concat(['<a class="op_zx_cinema_btn c-btn c-btn-primary c-btn-mini" target="_blank" href="',htmlData.cinemaurl,'">影讯/订座</a>']);break;case "0" :case "2" :html = html.concat(['{%*i*%}<a class="op_zx_cinema_btn c-btn c-btn-primary c-btn-mini" target="_blank" href="',htmlData.cinemaurl,'">查看影讯</a>']);break;}html.push('<div style="clear:both;" />');return html.join('');}function dealTime(time){var now = new Date(parseInt(bds.comm.serverTime+'000')),h = now.getHours(),m = now.getMinutes(),nowTime = (h<10?('0'+h):h) + ':' + (m<10?('0'+m):m),tarr = time.split('|'),len = tarr.length,todayFlag = 0,overFlag = 0;if (formatDate(now, 'yyyy-MM-dd') >= $dateDom.find('.op_zx_cinema_select'{%*i*%}).eq(0).attr('data-key')) {todayFlag = 1;}for (var i = 0; i < len; i++){if (todayFlag && nowTime > tarr[i] && i < len-1 ) {tarr.shift();i--;len--;} else {tarr[i] = '<span>' + tarr[i] + '</span>';}}if( tarr.length > 5) {tarr.splice(5,tarr.length);overFlag = 1;}return overFlag?tarr.join('|') + '<span>...</span>':tarr.join('|');}function formatDate(date, format){var o = {"M+" : date.getMonth()+1, "d+" : date.getDate(), "h+" : date.getHours(), "m+" : date.getMinutes(), "s+" : date.getSeconds(), "q+"{%*i*%} : Math.floor((date.getMonth()+3)/3), "S" : date.getMilliseconds() };if(/(y+)/.test(format)) format=format.replace(RegExp.$1,(date.getFullYear()+"").substr(4 - RegExp.$1.length));for(var k in o) {if(o.hasOwnProperty(k)){ if(new RegExp("("+ k +")").test(format)) {format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));}}} return format;}function limitLen(str, maxlen) {if ($.getByteLength(str) > maxlen) {str = $.subByte(str, maxlen) + '...';}return s{%*i*%}tr;}function modTag($el){if (!$el.hasClass('op_zx_cinema_select') && !$el.hasClass('op_zx_cinema_noselect')) {var $select = $el.parent().find('.op_zx_cinema_select').eq(0);if ($select.length>0) {$select.removeClass('op_zx_cinema_select');}$el.addClass('op_zx_cinema_select');getInfo();}}function modSite(index){if (!_this.data.condi.source[siteIndex].hasSubCate) {return;}var dateData = _this.data.condi.source[index].date,dateArr = _this.data.dateArr,lenI = dateArr.length,lenJ = dateData.length,new{%*i*%}Date = 0,dateIndex = 0,oldDate = 0,firstFlag = 1;for (var i = 0; i < lenI; i++) {var hasFlag = 0;for (var j = 0; j < lenJ; j++) {if (dateData[j].k == dateArr[i]) {hasFlag = 1;break;};};if ($dateDom.find('a').eq(i).hasClass('op_zx_cinema_select')) {oldDate = $dateDom.find('a').eq(i).attr('data-key');}if (hasFlag) {$dateDom.find('a').eq(i).removeClass('op_zx_cinema_noselect');if (firstFlag) {newDate = $dateDom.find('a').eq(i).attr('data-key');dateIndex = i;firstFlag = 0;}} else {$dateDom.find('a'){%*i*%}.eq(i).addClass('op_zx_cinema_noselect');}}if ($dateDom.find('.op_zx_cinema_select').eq(0).hasClass('op_zx_cinema_noselect')) {$dateDom.find('.op_zx_cinema_select').eq(0).removeClass('op_zx_cinema_select');$dateDom.find('a').eq(dateIndex).addClass('op_zx_cinema_select');modDate(newDate); } else {modDate(oldDate); }}function modDate(selectDate){var source = _this.data.condi.source[siteIndex],len = source.date.length,areaData;if (!len) {return;}for (var i = 0; i < len; i++){if (source.date[i].k =={%*i*%} selectDate) {areaData = source.date[i].area;break;} }if (!areaData) {return;}var areaArr = _this.data.condi.area_stat,lenJ = areaData.length,lenI = areaArr.length;for (var i = 0; i < lenI; i++) {var hasFlag = 0;for (var j = 0; j < lenJ; j++) {if (areaData[j].k == areaArr[i].k) {hasFlag = 1;break;};};if (hasFlag) {$areaDom.find('a').eq(i+1).removeClass('op_zx_cinema_noselect');} else {$areaDom.find('a').eq(i+1).addClass('op_zx_cinema_noselect');}}if ($areaDom.find('.op_zx_cinema_select').eq(0).h{%*i*%}asClass('op_zx_cinema_noselect')) {$areaDom.find('.op_zx_cinema_select').eq(0).removeClass('op_zx_cinema_select');$areaDom.find('a').eq(0).addClass('op_zx_cinema_select');}}this.dispose = function(){clearTimeout(loadOut);if(!ajaxFinished){ajaxFinished = true;}};});</script>{%/block%}
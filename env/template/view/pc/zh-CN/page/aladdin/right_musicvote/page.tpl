{%extends 'c_right_base.tpl'%} {%block name='data_modifier'%} {%if !$tplData.dataapi%} {%$tplData.dataapi='http://opendata.baidu.com/nba.php?type=3&flag=2&ie=utf-8&oe=utf-8'%} {%/if%} {%if !$tplData.voteapi%} {%$tplData.voteapi='http://opendata.baidu.com/nba.php?type=3&flag=1&ie=utf-8&oe=utf-8'%} {%/if%}{%/block%}{%block name='content'%}<style>{%if $tplData.rule%}.opr-right-musicvote-content{border-bottom:1px solid #e1e1e1;padding-bottom:18px}{%/if%}</style><div class="c-abstract opr-right-musicvote-content"> {%*临时trick处理，只有音乐风云榜投票出顶部banner,其他资源不出顶部的banner*%} {%if $extData.resourceid==12031%} <div class="opr-right_musicvote-banner"> <div class="opr-right-musicvote-banner-l"></div> <div class="opr-right-musicvote-banner-s"></div> </div> {%/if%} {%if $tplData.maletitle%} <div class="opr-right-musicvote-box opr-right-musicvote-default" style="margin-top:0px;"></div> {%/if%} {%if $tplData.femaletitle%} <div class="opr-right-musicvote-box opr-right-musicvote-default"></div> {%/if%} {%if $tplData.grouptitle%} <div class="opr-right-musicvote-box opr-right-musicvote-default"></div> {%/if%} <div class="opr-right-musicvote-bottom-total"></div> {%if $tplData.rule%}<div class="opr-right-musicvote-rule">{%$tplData.rule|escape%}</div>{%/if%} {%if $tplData.sharetitle%} <p class="opr-right-musicvote-share-title c-gap-top-small">分享：</p> <div class="opr-right-musicvote-share-container" data-click="{fm:'beha'}"></div> {%/if%}</div><script >
    A.setup({
        order: '{%$tplData.order|escape|escape:'javascript'%}',
        titles: {'male':'{%$tplData.maletitle|escape|escape:'javascript'%}', 'female':'{%$tplData.femaletitle|escape|escape:'javascript'%}', 'group':'{%$tplData.grouptitle|escape|escape:'javascript'%}'},
        {%if $tplData.malelist%}
        malelist:[{%foreach $tplData.malelist as $item%}{name:'{%$item.name%}',link:'{%$item.link%}'}{%if !$item@last%},{%/if%}{%/foreach%}],
        {%/if%}
        {%if $tplData.femalelist%}
        femalelist:[{%foreach $tplData.femalelist as $item%}{name:'{%$item.name%}',link:'{%$item.link%}'}{%if !$item@last%},{%/if%}{%/foreach%}],
        {%/if%}
        {%if $tplData.grouplist%}
        grouplist:[{%foreach $tplData.grouplist as $item%}{name:'{%$item.name%}',link:'{%$item.link%}'}{%if !$item@last%},{%/if%}{%/foreach%}],
        {%/if%}
        dataapi: '{%$tplData.dataapi%}',
        voteapi: '{%$tplData.voteapi%}',
        {%if $tplData.endtime%}
        endtime: '{%$tplData.endtime%}',
        {%/if%}
        listtotal: '{%$tplData.listtotal|escape|escape:'javascript'%}',
        bottomtotal: '{%$tplData.bottomtotal|escape|escape:'javascript'%}',
        sharetitle: '{%$tplData.sharetitle|escape|escape:'javascript'%}',
        sharedesc: '{%$tplData.sharedesc|escape|escape:'javascript'%}'
    });
</script><script>A.setup(function(){var _this = this;var ajaxFinished = false;var boxes = _this.find('.opr-right-musicvote-box');var total = _this.find('.opr-right-musicvote-bottom-total').get(0);var listColors = ['opr-right-musicvote-first', 'opr-right-musicvote-second', 'opr-right-musicvote-third'];var dataapi = /\?/.test(_this.data.dataapi)?_this.data.dataapi:_this.data.dataapi+'?';var voteapi = /\?/.test(_this.data.voteapi)?_this.data.voteapi:_this.data.voteapi+'?';var voteMale = null, voteF{%*i*%}emale = null, voteGroup = null;var votes = _this.data.order.split(',');var isVoteEnd = _this.data.endtime&&((+new Date())>=_this.data.endtime*1000)?true:false;var $shareContainer = _this.find('.opr-right-musicvote-share-container');var share = null;loadData();function Vote(ops){this.box = $(ops.box);this.data = ops.data;isVoteEnd&&this.data&&(this.data.voted=isVoteEnd);this.name = this.data.name;this.title = this.data.title;this.state = 'default';this.init();return this;}Vote.prototype = {init: {%*i*%}function(){this.initDoms();this.bindEvents();},initDoms: function(){var t = this;var html = ''+'<table class="c-table">'+'<thead><th style="padding-left:0;" colspan="4">'+this.title+'</th></thead>'+'<tbody>';for(var i = 0, o; o = this.data.list[i]; i++){var subBytedStr = subByte(o.name, 14);var tempList = _this.data[t.name+'list'];var link = null;if(tempList && tempList.length > 0){for(var j = 0; j < tempList.length; j++){if(this.data.list[i]['name'] == tempList[j]['name']){link = tempList[j]['l{%*i*%}ink'];break;}}}html+='<tr>'+'<td class="opr-right-musicvote-col-index"><i'+(i<3?(' class="'+listColors[i]+'"'):'')+'>'+(i+1)+'</i></td>'+ '<td class="opr-right-musicvote-col-name"'+ ((subBytedStr.indexOf('…') > -1) ? (' title="'+ (o.name) +'"') : '') +'>'+(link ? ('<a href="'+ link +'" target="_blank">') : '')+rmencodeHTML(subBytedStr)+(link ? ('</a>') : '')+'</td>'+'<td class="opr-right-musicvote-col-num"><span>'+getFormatNum(o.num, _this.data.listtotal)+'</span></td>'+'<td class="opr-right-mus{%*i*%}icvote-col-btn"><div class="opr-right-musicvote-btn'+((o.voted||isVoteEnd)?' opr-right-musicvote-btn-voted':( (t.data&&o.name==t.data.votedName) ? ' opr-right-musicvote-btn-voted' : '' ))+' OP_LOG_BTN"'+(this.data.voted?' data-nolog="1"':'')+' data-click="{fm:&apos;beha&apos;}" data-name="'+$.trim(o.name)+'"><span'+(this.data.voted?' data-nolog="1"':'')+'>&nbsp;</span>支持</div></td>'+'</tr>';}html+='</tbody>'+'</table>';this.box.html(html);if(this.data.voted){t.box.removeClass('opr-right-musicvot{%*i*%}e-default');t.box.addClass('opr-right-musicvote-disabled');}this.btns = this.box.find('.opr-right-musicvote-btn'); },bindEvents: function(){var t = this, $temp;if(!t.data.voted){this.btns.hover(function(){if(t.data.voted){return;}$temp = $(this);$temp.toggleClass('opr-right-musicvote-btn-hover');}).click(function(){if(t.data.voted){return;}$temp = $(this);$temp.addClass('opr-right-musicvote-btn-voted');t.box.removeClass('opr-right-musicvote-default');t.box.addClass('opr-right-musicvote-disabled'{%*i*%});var offset = $temp.offset();var $div = $('<div style="position:absolute;left:'+(offset.left-20)+'px;top:'+(offset.top+5)+'px;color:#ed4040;">+1</div>');$div.appendTo(document.body).animate({top: (offset.top-12),opacity: 0}, function(){$div.remove();});t.voted = true;t.votedName = $temp.attr('data-name');if(t.data){t.data.voted = true;t.data.votedName = t.votedName;}$.ajax({url:voteapi+'&name='+encodeURIComponent($temp.attr('data-name'))+'&vid='+encodeURIComponent($.getCookie('BAIDUID'))+'&t='+{%*i*%} new Date().getTime(),dataType:'jsonp',success:function(data){ if(ajaxFinished) return;if(data && data.status == '0'){if(data.data){data = data.data; if(data && data[t.name] && data[t.name]['list'] && data[t.name]['list'].length){t.refresh(data);var allnum = data.allnum;if(allnum){$(total).html(getFormatNum(allnum, _this.data.bottomtotal).replace(/(\d+)/, '<span>\x241</span>'));}}else{ var $num = $temp.parent().prev().find('span'); var curNum = $num.html();if(!/[\u4e07\u4ebf]/.test(curNum)){$num{%*i*%}.html(curNum.replace(/(\d+)/,function(originStr, num){if(num){num = parseInt(num, 10);if(num){return ++num;}}}));} } }}else{ var $num = $temp.parent().prev().find('span'); var curNum = $num.html();if(!/[\u4e07\u4ebf]/.test(curNum)){$num.html(curNum.replace(/(\d+)/,function(originStr, num){if(num){num = parseInt(num, 10);if(num){return ++num;}}}));}} },timeout: 5000,jsonp:'cb'});});}},refresh: function(data){var t = this;this.data = {name: this.name,title: this.title, voted: data[this.name]['vote{%*i*%}d'] || t.voted || isVoteEnd,list: data[this.name]['list'],votedName: t.votedName};this.initDoms();this.bindEvents();}};function loadData(){$.ajax({url:dataapi+'&vid='+encodeURIComponent($.getCookie('BAIDUID'))+'&t='+ new Date().getTime(),dataType:'jsonp',success:function(data){ if(ajaxFinished) return;if(data && data.status == '0'){data = data.data;if(data){for(var i = 0; i < votes.length; i++){data[votes[i]]['name'] = votes[i];data[votes[i]]['title'] = _this.data.titles[votes[i]];}render(data);{%*i*%}}}},timeout:5000,jsonp:'cb'});}function rmencodeHTML(source) {return String(source).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g, "&quot;").replace(/'/g, "&#39;");};function render(data){for(var i = 0; i < votes.length; i++){new Vote({box: boxes[i], data: data[votes[i]]});}var allnum = data.allnum;if(allnum){$(total).html(getFormatNum(allnum, _this.data.bottomtotal).replace(/(\d+)/, '<span>\x241</span>'));}}function subByte(str, len, tail){var a = [], s = str.spli{%*i*%}t('');tail = tail || '…';for(var i = 0, l = s.length; i < l; i++){if(s[i].charCodeAt(0) > 255){a.push("*");}a.push(s[i]);}if(len && len > 0 && a.length > len){s = a.join("").substring(0, len - 1).replace(/\*/g,'') + tail;}else{return str;}return s;};function getFormatNum(num, formatStr){var reg = /(\{)(\d*)(.*?)(\})/;var str = formatStr.replace(reg, function(originStr, leftDelimiter, number, unit, rightDelimiter){var rs = num;num = parseInt(num, 10);if(num && number){number = parseInt(number, 10{%*i*%});if(number){if(num < number){rs = num;}else{rs = Math.floor(num/number);if(unit){rs += unit;}}}}return rs;});return str;}if(_this.data.sharetitle){bds.ready(function(){A.use('share', function(){share = A.ui.share($shareContainer.get(0),{text:_this.data.sharetitle,desc:_this.data.sharedesc});}); });}this.dispose = function(){if(!ajaxFinished){ajaxFinished = true;}if(share && share.dispose){share.dispose();}};});</script>{%/block%}
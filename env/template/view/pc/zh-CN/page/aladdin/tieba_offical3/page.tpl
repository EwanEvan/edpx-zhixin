{%extends 'c_base.tpl'%} {%block name='data_modifier'%}{%$extData.feData.hasBorder=true%}{%$extData.feData.hasTitleGap = false%}{%/block%}{%block name='content'%}<div class="c-border"> <div class="c-row op-tieba-offical c-clearfix"> <div class="c-span4 op-tieba-offical-pic"> <a href="{%$tplData.homepostlink%}" target="_blank"><img class="c-img c-img4" src="{%$tplData.homepostlink%}"  /></a> <span>官方贴吧</span> </div> <div class="c-span20 c-span-last"> {%if $tplData.con%}<p>{%$tplData.con%}</p>{%/if%} <p><span class="c-gap-right">关注：{%if $tplData.membernum%}<strong>{%$tplData.membernum%}</strong>{%/if%}</span><span>贴子：{%if $tplData.postnum%}<strong>{%$tplData.postnum%}</strong>{%/if%}</span></p> {%if $tplData.link%} <p> {%foreach $tplData.link as $item%}<a href="{%$item.href%}" target="_blank">{%$item.txt%}</a>{%if !$item@last%}<span class="c-gap-left-small c-gap-right-small">|</span>{%/if%}{%/foreach%} </p> {%/if%} </div> </div> <table width="100%" border="0" cellspacing="0" cellpadding="0" class="op_tieba_live_table c-gap-top"> <tr> {%if $tplData.thread%}<td><a class="op_tieba_live_title c-gap-right" href="{%$tplData.thread[0]['link']%}"  target="_blank">{%$tplData.thread[0]['txt']%}</a><span class="c-text c-text-important">直播中</span></td>{%/if%} <td class="op_tieba_live_mutual">观众：<span class="op-tieba-live-audience c-gap-right"></span> 回复：<span class="op-tieba-live-answers"></span></td> </tr> </table> <div class="op_tieba_live_outer"> <div style="position:relative;"> <div class="op_tieba_live_talk_wamp" style=""> <div class="op_tieba_live_talk"></div> </div> <div class="op_tieba_live_talk_scrollbar"></div> </div> <div class="op_tieba_live_talk_blank"></div> <div style="position:relative;overflow:hidden;height:312px;"> <div class="op_t{%*i*%}ieba_live_layer1"><a href="{%$tplData.tieba[0]['link']%}" target="_blank">点击查看更多评论&gt;&gt;</a></div> <div class="op_tieba_live_wamp"> <div class="op_tieba_live_inner"> </div> <div class="op_tieba_live_inner_scrollbar"> </div> </div> <div class="op_tieba_live_layer2"><a href="{%$tplData.tieba[0]['link']%}" target="_blank">点击查看更多评论&gt;&gt;</a></div> </div> </div> <div class="op_tieba_live_join c-clearfix"> <a class="c-btn c-btn-primary" type="submit" href="{%$tplData.url%}" target="_blank">进入贴吧讨论</a> </div> </div><script >
    A.setup({ 
       fid:{%$tplData.fid%},
       tid:{%$tplData.tid%},
       talkid:{%$tplData.talkid%}
    });
</script><script> A.setup(function(){var _this = this;var oInner = _this.find(".op_tieba_live_inner").get(0);var oBlank = _this.find(".op_tieba_live_talk_blank").get(0);var oWamp = _this.find(".op_tieba_live_wamp").get(0);var oTalkWamp = _this.find(".op_tieba_live_talk_wamp").get(0);var oInnerScrollbar = _this.find(".op_tieba_live_inner_scrollbar").get(0);var oTalkScrollbar = _this.find(".op_tieba_live_talk_scrollbar").get(0);var oTalkInner = _this.find(".op_tieba_live_talk").get(0); var oMask1 {%*i*%}= _this.find(".op_tieba_live_layer1").get(0);oMask1.style.display='none';var oMask2 = _this.find(".op_tieba_live_layer2").get(0);var dataArray = [];var dataTalkArray = [];var controlArray = [];var controlTalkArray = [];var timer = null;var lessfiftytimer = null;var constanttimer = null;var liveAudience = _this.find(".op-tieba-live-audience").get(0);var liveAnswers = _this.find(".op-tieba-live-answers").get(0);var liveAudienceNum;var liveAnswersNum;var num = 0;var i = 0;var k = 0;var arr1 = [];va{%*i*%}r arr2 = [];var serverTime = 0;var isAnimaiting = false;var flag = false; var ajaxurl = "http://tieba.baidu.com/zhibo/talk/post?fid=" + _this.data.fid + "&tid=" + _this.data.tid +"&rn=30&cb=bd_cb_tieba_broadcast&t=";var ajaxurltalk = "http://tieba.baidu.com/zhibo/talk/talk?fid="+ _this.data.fid + "&tid=" + _this.data.tid +"&talkid="+ _this.data.talkid + "&direction=0&rn=30&cb=bd_cb_tieba_broadcast&t=";var oFragment = document.createDocumentFragment();var oTalkFragment = document.createDocumentFr{%*i*%}agment();var listScrollbar;var scrollTimer;var talkMaxNum = 0;var postMaxNum = 0;var postAddFlag = true;var talkAddFlag = true;var firstGetNum = true;var oMaskTimer = null;var serverTimerAddTimer; var animation;var animation2;var reg = /\[(\u56fe\u7247|\u89c6\u9891|\u97f3\u4e50)\]/;var reg2 = /\[face\].*?\[\/face\]/;function scrollfn(){ A.use('scrollbarv',function(){ listScrollbar= A.ui.scrollbarv({ content : oWamp,scrollbar : oInnerScrollbar,initPos : 1,mousewheellock: true});});};function scro{%*i*%}llTalkfn(){ A.use('scrollbarv',function(){ listScrollbar= A.ui.scrollbarv({ content : oTalkWamp,scrollbar : oTalkScrollbar,initPos : 1,mousewheellock: true});});};function createTalkDl(obj){ if(obj.question && obj.answer){if(obj.question){ var newDivChildOne = createTalkNewdiv(obj.question); newDivChildOne.className = 'op_tieba_live_list_div2_one c-clearfix'; }if(obj.answer){ var newDivChildTwo = createTalkNewdiv(obj.answer);newDivChildTwo.className = 'op_tieba_live_list_div2_two c-clearfix'; }v{%*i*%}ar newDiv = document.createElement("DIV");newDiv.appendChild(newDivChildOne);newDiv.appendChild(newDivChildTwo); newDiv.className = 'op_tieba_live_list_div2'; newDiv.setAttribute('data-id',obj.answer.id);return newDiv; }else if(obj.comment){ var newDiv = createTalkNewdiv(obj.comment);newDiv.className = 'op_tieba_live_list_div';newDiv.setAttribute('data-id',obj.comment.id);return newDiv;} }; function createTalkNewdiv(obj){var newDiv = document.createElement("DIV"); var newChildDiv1 = document.cre{%*i*%}ateElement("DIV"); newChildDiv1.className = 'op_tieba_live_list_pic c-gap-right'; var newSpan = document.createElement("SPAN");var txtCon = '';if(obj.user.type == 1){txtCon = '主持';}else if(obj.user.type == 2){txtCon = '嘉宾';}var textNode0 = document.createTextNode(txtCon);newSpan.appendChild(textNode0);newSpan.className = 'op_tieba_live_tip'+obj.user.type; newChildDiv1.appendChild(newSpan); newDiv.appendChild(newChildDiv1);var newChildDiv2 = document.createElement("DIV");newChildDiv2.className = {%*i*%}'op_tiaba_live_list_con c-gap-right'; newDiv.appendChild(newChildDiv2);var newChildDiv3 = document.createElement("DIV");newChildDiv3.setAttribute('data-time',obj.time);var textNode = document.createTextNode(formatTime(newChildDiv3));newChildDiv3.appendChild(textNode);newChildDiv3.className = 'op_tieba_live_list_time'; newDiv.appendChild(newChildDiv3);var newSpan1 = document.createElement("SPAN");newSpan1.className = 'op_list_name'; var textNode1 = document.createTextNode(obj.user.name + ':');new{%*i*%}Span1.appendChild(textNode1);var newA2 = document.createElement("A");newA2.href = "http://www.baidu.com/p/" + obj.user.name + "?from=tieba";newA2.target = "_blank";newA2.appendChild(newSpan1); newChildDiv2.appendChild(newA2); var newSpan2 = document.createElement("SPAN");newSpan2.className = 'op_list_txt'; var txt2 = subByte(obj.contents, 120);var txt3 = txt2.replace(reg2,'[图片]');newSpan2.innerHTML = txt3;if(txt2.indexOf('…') > -1 || reg.test(obj.contents) || reg2.test(obj.contents)){newChildDiv{%*i*%}2.appendChild(newSpan2);var newA3 = document.createElement("A");var textNode3 = document.createTextNode('查看全部>>');newA3.appendChild(textNode3);newA3.href = "http://tieba.baidu.com/p/"+ _this.data.tid + "?pid=" + obj.id + "#" +obj.id;newA3.target = "_blank";newChildDiv2.appendChild(newA3); }else{newChildDiv2.appendChild(newSpan2);}var newImg = document.createElement("IMG");newImg.className = 'c-img c-img3';newImg.src = 'http://tb.himg.baidu.com/sys/portrait/item/' + obj.user.portrait;var newA = d{%*i*%}ocument.createElement("A");newA.href = "http://www.baidu.com/p/" + obj.user.name + "?from=tieba";newA.target = "_blank";newA.appendChild(newImg); newChildDiv1.appendChild(newA); return newDiv;}function createDl(obj){var newDl = document.createElement("DL");newDl.className = 'op_tieba_live_list_dl c-clearfix'; var newDd1 = document.createElement("DD");newDd1.className = 'op_tieba_live_list_pic c-gap-right'; newDl.appendChild(newDd1); var newDd2 = document.createElement("DD");newDd2.className = 'o{%*i*%}p_tiaba_live_list_con c-gap-right'; newDl.appendChild(newDd2);var newDd3 = document.createElement("DD");newDd3.setAttribute('data-time',obj.time);var textNode = document.createTextNode(formatTime(newDd3));newDd3.appendChild(textNode);newDd3.className = 'op_tieba_live_list_time'; newDl.appendChild(newDd3);var newSpan1 = document.createElement("SPAN");newSpan1.className = 'op_list_name'; newSpan1.innerHTML = obj.user.name + ':';newDd2.appendChild(newSpan1);var newA1 = document.createElement("A");n{%*i*%}ewA1.href = "http://www.baidu.com/p/" + obj.user.name + "?from=tieba";newA1.target = "_blank";newA1.appendChild(newSpan1); newDd2.appendChild(newA1);var txt2 = subByte(obj.contents, 116); var newSpan2 = document.createElement("SPAN");newSpan2.className = 'op_list_txt'; newSpan2.innerHTML = txt2;if(txt2.indexOf('…') > -1 || reg.test(obj.contents)){ var newA3 = document.createElement("A");var textNode3 = document.createTextNode('查看全部>>');newA3.appendChild(textNode3);newA3.href = "http://tieba.baid{%*i*%}u.com/p/"+ _this.data.tid + "?pid=" + obj.id + "#" +obj.id;newA3.target = "_blank";newDd2.appendChild(newSpan2);newDd2.appendChild(newA3); }else{newDd2.appendChild(newSpan2);}var newImg = document.createElement("IMG"); newImg.className = 'c-img c-img3';newImg.src = 'http://tb.himg.baidu.com/sys/portrait/item/' + obj.user.portrait;var newA = document.createElement("A");newA.href = "http://www.baidu.com/p/" + obj.user.name + "?from=tieba";newA.target = "_blank";newA.appendChild(newImg); newDd1.app{%*i*%}endChild(newA);newDl.setAttribute('data-id',obj.id); return newDl;}; function subByte(str, len, tail){ var a = [], s = str.split('');tail = tail || '…'; for(var i = 0, l = s.length; i < l; i++){if(s[i].charCodeAt(0) > 255){a.push("*");}a.push(s[i]);}if(len && len > 0 && a.length > len){ s = a.join("").substring(0, len - 1).replace(/\*/g,'') + tail;}else{return str;}return s;};function animationfn(oWamp,i){A.use('animation', function(){animation = A.ui.animation(function(){this.tween({ y: oWamp.s{%*i*%}crollTop}).to({y:oWamp.scrollTop + 78*i}, 1000*i).easing(this.Easing.Quadratic.InOut).onUpdate(function(){oWamp.scrollTop = this.y;}).onComplete(function(){ animation.stop();if(controlArray.length==29){controlArray.shift();oInner.removeChild(oInner.getElementsByTagName('DL')[0]); }if(oWamp == oTalkWamp){scrollTalkfn();}else{scrollfn();}isAnimaiting = false;}).start();isAnimaiting = true;}).start();});};function animationfnfloat(oWamp){ A.use('animation', function(){animation2 = A.ui.animation(fu{%*i*%}nction(){var bt = -25;this.tween({ y: bt}).to({y:bt + 25}, 1000).easing(this.Easing.Quadratic.InOut).onUpdate(function(){if(oWamp == oMask1){oWamp.style.top = this.y + 'px';}else{oWamp.style.bottom = this.y + 'px';}}).onComplete(function(){ animation2.stop();}).start();}).start();});};window.bd_cb_tieba_broadcast = function(data){ if(data && data.data && data.data.post_list){ data = data.data;serverTime = data.server_time;clearInterval(serverTimerAddTimer);serverTimeAdd();liveAudienceNum = data.{%*i*%}join_num;liveAnswersNum = data.reply_num;if(firstGetNum){liveAudience.innerHTML = liveAudienceNum;liveAnswers.innerHTML = liveAnswersNum; firstGetNum = false;}; if(controlArray.length == 0 ){for(var i=0;i<data.post_list.length;i++){var oDl = createDl(data.post_list[i]);controlArray.push(oDl); oFragment.appendChild(oDl);}updatetime(controlArray); oInner.appendChild(oFragment);scrollfn(); }else{if(postAddFlag){postMaxNum = controlArray[controlArray.length-1].getAttribute('data-id');postAddFlag = f{%*i*%}alse;}for(var i=0;i<data.post_list.length;i++){if(data.post_list[i].id > postMaxNum){dataArray.push(data.post_list[i]); postMaxNum = data.post_list[i].id;}}; }};if(data && data.data && !data.data.talk){oTalkWamp.style.display = 'none';oBlank.style.display = "none"; _this.find(".op_tieba_live_talk_wamp")[0].style.height = 0 +"px";}; if(data && data.data && $.type(data.data.talk) === 'array' && data.data.talk.length === 0){oTalkWamp.style.display = 'none';oBlank.style.display = "none"; _this.find({%*i*%}".op_tieba_live_talk_wamp")[0].style.height = 0 +"px";};if(data && data.data && data.data.talk){ data = data.data; serverTime = data.server_time;clearInterval(serverTimerAddTimer);serverTimeAdd(); if(controlTalkArray.length == 0 ){for(var i=0;i<data.talk.length;i++){if(data.talk[i].comment && data.talk[i].comment.del == 1 ){continue;}else if(data.talk[i].answer && data.talk[i].answer.del == 1 ){continue; }else if(data.talk[i].question && data.talk[i].question.del == 1 ){continue; }else{var oDl ={%*i*%} createTalkDl(data.talk[i]); controlTalkArray.push(oDl); oTalkFragment.appendChild(oDl); }} updatetime(controlTalkArray);oTalkInner.appendChild(oTalkFragment);scrollTalkfn();}else{if(talkAddFlag){ talkMaxNum = controlTalkArray[controlTalkArray.length-1].getAttribute('data-id');talkAddFlag = false;}for(var i=0;i<data.talk.length;i++){if(data.talk[i].comment && data.talk[i].comment.id && data.talk[i].comment.id > talkMaxNum){if(data.talk[i].comment.del == 1){return;}dataTalkArray.push(data.talk[i]{%*i*%});talkMaxNum = data.talk[i].comment.id;}if(data.talk[i].answer && data.talk[i].answer.id && data.talk[i].answer.id > talkMaxNum){if(data.talk[i].answer.del == 1 || data.talk[i].question.del == 1){return;}dataTalkArray.push(data.talk[i]);talkMaxNum = data.talk[i].answer.id;}};}};}; function serverTimeAdd(){ serverTimerAddTimer = setInterval(function(){serverTime += 1;},1000);};function updatetime(controlArray){$.each(controlArray, function(i, n){var currentDd = $(n).find(".op_tieba_live_list_time{%*i*%}").get(0);if(currentDd){currentDd.innerHTML = formatTime(currentDd); }var currentDd2 = $(n).find(".op_tieba_live_list_time").get(1);if(currentDd2){currentDd2.innerHTML = formatTime(currentDd2); } });};function formatTime(obj){ var leftTime = serverTime - parseInt(obj.getAttribute('data-time'),10); var thatTime = parseInt(obj.getAttribute('data-time'),10);var rsTime = '';if (leftTime <= 0){ rsTime = '刚刚';}else if (leftTime < 60) {rsTime = leftTime + '秒前';} else if (leftTime < 60*60) {rsTime = par{%*i*%}seInt(leftTime/60) + '分前';} else if (leftTime < 60*60*24) { rsTime = calcTime(thatTime);} else {return parseInt(leftTime/60/60/24) + '天前';} return rsTime;};function calcTime(thatTime){var oServerTime = new Date(serverTime*1000);var oServerDate = oServerTime.getDate();var oFatie = new Date(thatTime*1000); var oOneDate = oFatie.getDate();var hoursNum = oFatie.getHours();var minutesNum = oFatie.getMinutes();if(hoursNum<10){hoursNum = "0" + hoursNum; } if(minutesNum<10){minutesNum = "0" + minutesNum{%*i*%}; } var str = hoursNum + ":" + minutesNum ;if(oServerDate == oOneDate){return str;}else{return "1天前";};};function ajaxfn(ajaxurlele){$.getJSON(ajaxurlele+(+new Date())+'&callback=?',function(data){ });};ajaxfn(ajaxurl);ajaxfn(ajaxurltalk);constanttimer = setInterval(function(){ajaxfn(ajaxurl); ajaxfn(ajaxurltalk);},10000); var animating = true;var noScroll = false;var oMask1HasShowed = true;lessfiftytimer = setInterval(function(){ if((oInner.offsetHeight - oWamp.scrollTop - 4*78) < 2*78){noScrol{%*i*%}l = false;oWamp.scrollTop = oInner.offsetHeight - 4*78;} if(noScroll){return;}; if(dataArray.length >= 50){ oMask2.style.display = 'block';if(animating == true){animationfnfloat(oMask2);animating = false;} };updatetime(controlArray); updatetime(controlTalkArray);liveAudience.innerHTML = liveAudienceNum;liveAnswers.innerHTML = liveAnswersNum;if(dataArray.length > 0){ if(dataArray.length >= 4){for(var i=0;i<4;i++){var oDl = createDl(dataArray[0]);controlArray.push(oDl); oInner.appendChild(oDl);dat{%*i*%}aArray.shift();}animationfn(oWamp,4); }else{var oDl = createDl(dataArray[0]);controlArray.push(oDl); oInner.appendChild(oDl);dataArray.shift();animationfn(oWamp,1); }scrollfn();}if(dataTalkArray.length > 0){var oTalkDl = createTalkDl(dataTalkArray[0]);controlTalkArray.push(oTalkDl); oTalkInner.appendChild(oTalkDl);dataTalkArray.shift();animationfn(oTalkWamp,1); scrollTalkfn();}},5000);oMaskTimer = setInterval(function(){if(oWamp.scrollTop == 0){oMask1.style.display = 'block'; if(oMask1HasShowed){%*i*%}{animationfnfloat(oMask1);oMask1HasShowed = false;} }else{oMask1.style.display = 'none';oMask1HasShowed = true;}if((oInner.offsetHeight - oWamp.scrollTop - 4*78) >= 2*78){scrollTimer = setTimeout(function(){ if((oInner.offsetHeight - oWamp.scrollTop - 4*78) < 2*78){noScroll = false;oWamp.scrollTop = oInner.offsetHeight - 4*78;clearTimeout(scrollTimer);scrollTimer = null;}},4000); noScroll = true;}},100);oMask2.onclick = function(){oInner.innerHTML = ""; controlArray = [];clearInterval(lessfiftyt{%*i*%}imer);clearInterval(constanttimer); ajaxfn(ajaxurl);this.style.display = "none";oMask1.style.display = "none";animating = true;};this.dispose = function(){clearTimeout(scrollTimer);clearInterval(oMaskTimer);clearInterval(lessfiftytimer);clearInterval(constanttimer);clearInterval(serverTimerAddTimer);window.bd_cb_tieba_broadcast = function(){};animation&&animation.dispose&&animation.dispose();animation2&&animation2.dispose&&animation2.dispose();listScrollbar&&listScrollbar.dispose&&listScrollbar.{%*i*%}dispose();};});</script>{%/block%}
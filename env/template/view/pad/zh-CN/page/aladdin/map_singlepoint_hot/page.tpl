{%extends 'c_base.tpl'%} {%block name="data_modifier"%}{%$tplData.url = $tplData.titleUrl%}{%/block%}{%block name='content'%}<style>{%fe_fn_c_css css='input'%}{%fe_fn_c_css css='tabs'%}{%fe_fn_c_css css='btn'%}.op-map-singlepoint-hothotmap{height:190px;background:url(http://api.map.baidu.com/staticimage?center={%$tplData.point[0].lng|escape:'url'%},{%$tplData.point[0].lat|escape:'url'%}&width=351&height=146&zoom=15) 0 0 no-repeat}.container_s .op-map-singlepoint-hothotmap{background:url(http://api.map.baidu.com/staticimage?center={%$tplData.point[0].lng|escape:'url'%},{%$tplData.point[0].lat|escape:'url'%}&width=259&height=146&zoom=15) 0 0 no-repeat}.op-map-singlepoint-hothotmap .BMap_cpyCtrl{display:none}.op-map-singlepoint-hothotright{position:relative;top:-2px}.op-map-singlepoint-hothothot-level-lable{font-family:微软雅黑;font-size:1.23em;line-height:1.23em}.op-map-singlepoint-hothothot-level-tag{font-family:微软雅黑;font-size:1.69em;line-height:1.69em}.op-map-singlepoint-hothothot-level-yongji-font-color{color:#f13e41}.op-map-singlepoint-hothothot-level-miji-font-color{color:#f4c537}.op-map-singlepoi{%*i*%}nt-hothothot-level-xishao-font-color{color:#54c279}.op-map-singlepoint-hothothot-level-yongji{background-color:#f13e41}.op-map-singlepoint-hothothot-level-miji{background-color:#f4c537}.op-map-singlepoint-hothothot-level-xishao{background-color:#54c279}.op-map-singlepoint-hothothot-level-icon{position:relative;top:-2px;width:5px;height:5px;overflow:hidden;display:inline-block}.op-map-singlepoint-hothotinput-container{float:left}.op-map-singlepoint-hothotbtn-container{float:left}.op-map-singlepoi{%*i*%}nt-hothotcontent .op-map-singlepoint-hothotinput{width:201px}.op-map-singlepoint-hothothot-gray{color:#666}</style>{%$hotmapurl = 'spotshot.baidu.com'%}{%if $tplData.poiname || strpos($tplData.point[0].link, $hotmapurl) !== false%} {%else%} {%if $tplData.title%} <div class="cr-title c-gap-bottom">地图信息</div> {%/if%}{%/if%}<div class="c-row op-map-singlepoint-hothot-box"> <div class="c-span15 op-map-singlepoint-hothotleft op-map-singlepoint-hothotmap"></div> <div class="c-span9 c-span-last op-map-singlepoint-hothotright"> <div> <div class="op-map-singlepoint-hothothot-level-lable">当前人流密度</div> <div class="op-map-singlepoint-hothothot-level-tag"></div> </div> <div class="op-map-singlepoint-hothothot-gray"> <span class="op-map-singlepoint-hothothot-level-icon op-map-singlepoint-hothothot-level-yongji">&nbsp;</span>&{%*i*%}nbsp;拥挤 <span class="c-gap-left op-map-singlepoint-hothothot-level-icon op-map-singlepoint-hothothot-level-miji">&nbsp;</span>&nbsp;密集 <span class="c-gap-left op-map-singlepoint-hothothot-level-icon op-map-singlepoint-hothothot-level-xishao">&nbsp;</span>&nbsp;稀少 </div> <div class="c-gap-top-small op-map-singlepoint-hothothot-gray"><span class="op-map-singlepoint-hothothot-update-time"></span>更新</div> <div class="c-gap-top-small" style="display:none;"> <span class="op-map-singlepoint-hothothot-g{%*i*%}ray">提醒：</span> <span class="op-map-singlepoint-hothothot-tip"></span> </div> <div> <a target="_blank" href="{%$tplData.parkUrl%}">附近停车场</a> <a target="_blank" href="{%$tplData.lkUrl%}" style="margin-left:20px;">实时路况</a> </div> </div></div><script >
    A.setup({"tplData": {%json_encode($tplData)%},'isHotMap':'1'});  
</script><script data-merge> A.setup(function(){var __this = this, _maploaded,time1 = null,time2 = null,$mapContainer = __this.find(".op-map-singlepoint-hothotmap").eq(0),initTime = new Date().getTime(), startTime, endTime;var hotLevelExpression = "[,10)稀少 [10,70)密集 [70,)拥挤";var hotLevelColorMap = {"稀少": "xishao", "密集": "miji", "拥挤": "yongji"};var $hotTag = __this.find('.op-map-singlepoint-hothothot-level-tag');var $hotUpdateTime = __this.find('.op-map-singlepoint-hothothot-update-time');var $ho{%*i*%}tTip = __this.find('.op-map-singlepoint-hothothot-tip');var poiname = __this.data.tplData.poiname;var hotMapUrl = __this.data.tplData.titleUrl;var hotTipMapping = {'拥挤': '拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤拥挤','密集': '密集密集密集密集密集密集密集密集密集密集密集密集密集','稀少': '稀少稀少稀少稀少稀少稀少稀少稀少稀少稀少稀少稀少稀少'};A._____map_singlepoint_hot = function(){var ajaxFinished = false;var anchor = new BMap.Size(0, -115),anchorMouseOver = new BMap.Size(0, -156),point = {lng: __this.data.tplData.lng, lat: __this.data.tplData.lat},mapPoint = new BMap{%*i*%}.Point( point.lng, point.lat);map = new BMap.Map( __this.find(".op-map-singlepoint-hothotmap").get(0), {'enableMapClick':false} );map.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_LEFT, type: BMAP_NAVIGATION_CONTROL_SMALL}));map.enableScrollWheelZoom();map.centerAndZoom( mapPoint , 10 );var iconURL = "http://www.baidu.com/aladdin/img/jigou/markers.png",marker = new BMap.Marker( mapPoint ),icon = new BMap.Icon(iconURL, new BMap.Size(34,39), {imageOffset:anchor}),iconHover = new B{%*i*%}Map.Icon(iconURL, new BMap.Size(34,39), {imageOffset:anchorMouseOver});marker.setIcon( icon );marker.setTitle( poiname);map.addOverlay( marker );var label = new BMap.Label('<a hideFocus="true" data-click="{fm:\'alxr\'}" href="'+ hotMapUrl +'" target="_blank" class="op-map-singlepoint-hothotmap-label">'+subByte(poiname,20)+'<a>',{offset:new BMap.Size(20,-10)});label.setStyle({ border:"none",backgroundColor:"none"});marker.setLabel(label);marker.addEventListener("click", function(){window.open(hot{%*i*%}MapUrl, "_blank");c({'fm':'alxr','rsv_srcid':__this.srcid,'p1':__this.p1,'p5':__this.p1,'mu':__this.mu,'title':'point','rsv_xpath':'div-div3-div','rsv_tpl':'map_singlepoint_hot'});});map.addEventListener("dragstart", function(){c({'fm':'beha','rsv_srcid':__this.srcid,'p1':__this.p1,'p5':__this.p1,'mu':__this.mu,'title':'drag','rsv_xpath':'div-div3-div','rsv_tpl':'map_singlepoint_hot'});});map.addEventListener("zoomstart", function(){c({'fm':'beha','rsv_srcid':__this.srcid,'p1':__this.p1,'p5':__t{%*i*%}his.p1,'mu':__this.mu,'title':'zoom','rsv_xpath':'div-div3-div','rsv_tpl':'map_singlepoint_hot'});});map.addEventListener("tilesloaded",function(){if(!__this.maploaded){__this.maploaded = 1;time1 = setTimeout(function(){$mapContainer.attr('background','none');},500);endTime = new Date().getTime();ns_c({'tab':'map_singlepoint_hot','waitTime':startTime-initTime,'loadTime':endTime-startTime});var mapBtn = __this.find('.BMap_stdMpPan .BMap_button');$.each(mapBtn, function(i,e){$(e).on('click', funct{%*i*%}ion(){c({'fm':'beha','rsv_srcid':__this.srcid,'p1':__this.p1,'p5':__this.p1,'mu':__this.mu,'title':'control','rsv_xpath':'div-div3-div','rsv_tpl':'map_singlepoint_hot'});});});}});$(window).on('resize',reMap);var oldWidth = window.document.documentElement.clientWidth;function subByte(str, len, tail){ var a = [], s = str.split('');tail = tail || '…'; for(var i = 0, l = s.length; i < l; i++){if(s[i].charCodeAt(0) > 255){a.push("*");}a.push(s[i]);}if(len && len > 0 && a.length > len){ s = a.join(""{%*i*%}).substring(0, len - 1).replace(/\*/g,'') + tail;}else{return str;}return s;}function reMap(){var width = window.document.documentElement.clientWidth;if ( (oldWidth < 1207 && width > 1207) || (oldWidth > 1207 && width < 1207) ) {oldWidth = width;time2 = setTimeout(function(){map.centerAndZoom( mapPoint , 10 );},100);}}if (__this.data.isHotMap) {var pattern=window.navigator.userAgent.match(/MSIE\s*(\d+)/);var ie68 = pattern && pattern[1] && parseInt(pattern[1])<9;var color = 'rgb(215,57,32)';if ({%*i*%}!poiname)return;var cityname = __this.data.tplData.cityname;var time = ( bds && bds.comm && bds.comm.serverTime )? bds.comm.serverTime-60: parseInt( new Date().getTime()/1000 ) - 60;var version;var polygonurl = "http://spotshot.baidu.com/getPoint.php?poiname="+encodeURIComponent(poiname)+"&city="+encodeURIComponent(cityname)+"&time="+time;var hoturl = "http://spotshot.baidu.com/getHotW.php?poiname="+encodeURIComponent(poiname)+"&city="+encodeURIComponent(cityname)+"&time="+time;var rankhoturl = {%*i*%}"http://spotshot.baidu.com/getRankHotView.php?poiname="+encodeURIComponent(cityname)+"&subpoiname="+encodeURIComponent(poiname)+"&time="+time;$.ajax({url: rankhoturl,dataType: 'jsonp',timeout: 6000}).done(function(data){if (ajaxFinished) return; if(data && data.data && data.data.hot !== undefined){var hotNumber = data.data.hot;var hotText = getRegionText(hotNumber, hotLevelExpression);$hotTag.html(hotText).addClass("op-map-singlepoint-hothothot-level-"+hotLevelColorMap[hotText]+"-font-color");; {%*i*%}$hotUpdateTime.html(data.NearestTime.length == 19 ? data.NearestTime.substr(0, 16) : data.NearestTime);}});if(ie68) {$.ajax({ url: 'http://spotshot.baidu.com/getVersion.php',dataType:'jsonp', timeout: 6000, jsonp:'callback',success: function(data){if (ajaxFinished) return; version = data.version;addMapLayer();return;}});} else {var script1 = document.createElement('script');__this.container.appendChild(script1);script1.src="http://spotshot.baidu.com/js/heatmap.js";var script2 = document.createEl{%*i*%}ement('script');__this.container.appendChild(script2);script2.src="http://spotshot.baidu.com/js/heatmap-bmaps.js";$.ajax({ url: hoturl,dataType:'jsonp', timeout: 6000, jsonp:'callback',success: function(hot){if (ajaxFinished) return; var heatOlay = new HeatmapOverlay(map, {"radius":10, "visible":true, "opacity":30});map.addOverlay(heatOlay);function addHeatPoints(rs){var tmmp = null;var px = null;var py = null;var phot = null;HotData.data=[];for(var i = 0; i < rs.length; i++){tmpp = rs[i];px = t{%*i*%}mpp.x;py = tmpp.y;phot = tmpp.hot;HotData.data.push({"lat": px, "lng": py, "count": phot}); } }var HotData = {"max": 4 ,"data":[]};addHeatPoints(hot.data);heatOlay['setDataSet'](HotData); }});$.ajax({ url: polygonurl,dataType:'jsonp', timeout: 6000, jsonp:'callback',success: function(result_){if (ajaxFinished) return; var pixels = result_.point;cityname = result_.city?result_.city:cityname;var points = [];for(var i = 0,item; item = pixels[i]; i++){var xy = item.split("|");var pixel = new BMap.Pi{%*i*%}xel(xy[0],xy[1]);points[i] = map.getMapType().getProjection().pointToLngLat(pixel);}var colorurl = "http://spotshot.baidu.com/getRankHotView.php?poiname="+encodeURIComponent(cityname)+"&time="+time;$.ajax({ url: colorurl,dataType:'jsonp', timeout: 6000, jsonp:'callback',success: function(result){for(var i = 0, poi; poi = result.data[i]; i++){if(poi['poiname'] == poiname){color = getColor(poi['hot']);}} var polygon = new BMap.Polygon(points, {strokeColor:color, strokeWeight:2, strokeOpacity:0.7, {%*i*%}fillColor:color,fillOpacity:0.2}); map.addOverlay(polygon); map.setViewport(polygon.getPath()); }});}});}function getColor(hot){var hotNum = parseInt(hot);if(1<=hotNum && hotNum<10){return "rgb(44,200,2)";}else if(10<=hotNum && hotNum<25){return "rgb(255,201,115)";}else if(25<=hotNum && hotNum<40){return "rgb(254,170,58)";}else if(40<=hotNum && hotNum<55){return "rgb(254,135,0)";}else if(55<=hotNum && hotNum<70){return "rgb(255,84,18)";}else if(70<=hotNum && hotNum){return "rgb(215,57,32)";}}fun{%*i*%}ction addMapLayer() {var TILE_BASE_URLS = ['http://shangetu0.map.bdimg.com/it/','http://shangetu1.map.bdimg.com/it/','http://shangetu2.map.bdimg.com/it/','http://shangetu3.map.bdimg.com/it/','http://shangetu4.map.bdimg.com/it/'];var tileLayer = new BMap.TileLayer({isTransparentPng: true});var tileCoord = {'x':point.lng,'y':point.lat};var zoom = 15;tileLayer.getTilesUrl = function(tileCoord, zoom) {var row = tileCoord.x;var column = tileCoord.y;var url = TILE_BASE_URLS[Math.abs(row + column) % TI{%*i*%}LE_BASE_URLS.length] + 'u=x=' + row + ';y=' + column + ';z=' + zoom + ';v='+ version +';type=hot&fm=44&t='+parseInt((new Date().getTime())/1000*60*10);return url.replace(/-(\d+)/gi, 'M\$1');};map.addTileLayer(tileLayer);} }};function getRegionText(number, regionExpression){return regionExpression.replace(/(\[|\()(\s?|\d+)\,(\s?|\d+)(\]|\))([^\s]+)\s?/g, function(str, left, min, max, right, text){min = left === '[' ? min : min === "" ? "" : min - 1;max = right === ']' ? max : max === "" ? "" : ma{%*i*%}x - 1;return ( min === "" ? number <= max : number >= min && ( max === "" ? true : number <= max ) ) ? text : '';});}bds.ready(function(){startTime = new Date().getTime();$.getScript("http://api.map.baidu.com/api?v=1.4&callback=A._____map_singlepoint_hot");}); this.dispose = function(){ajaxFinished = true; clearTimeout(time1);clearTimeout(time2);}; }); </script>{%/block%}
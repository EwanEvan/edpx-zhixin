{%extends 'right_base.tpl'%} {%block name='content'%}<style>.opr-vote-container,.opr-vote-head-icon,.opr-vote-flipboard div,.opr-vote-btn-rank,.opr-vote-btn-start,.opr-vote-btn-end,.opr-vote-sharebtn,.opr-vote-share-icon{background:url(http://www.baidu.com/aladdin/img/chinavoice/chinavoice-vote-bg.png) no-repeat}.opr-vote-container{position:relative;border:1px solid #efe7e6;background-position:0 -100px;padding-left:12px;padding-bottom:12px;zoom:1;width:234px}.opr-vote-head{height:40px;line-height:40px}.opr-vote-head-icon{position:absolute;left:0;t{%*i*%}op:0;width:18px;height:29px;background-position:-204px 0;float:left}.opr-vote-title{float:left;font-size:16px;font-weight:bold;color:#440a02;padding-left:10px}.opr-vote-rule{float:left;margin-left:20px;color:#7b423a}.opr-vote-flipboard-container{height:32px;line-height:32px;color:#7b423a;margin-left:-4px}.opr-vote-flipboard div{width:22px;height:31px;background-position:-204px -50px;float:left;margin-right:0;padding:2px 1px 0 1px}.opr-vote-flipboard span{width:20px;height:25px;background:url(htt{%*i*%}p://www.baidu.com/aladdin/img/chinavoice/flipboardnums.png) no-repeat;display:block}.opr-vote-rank-container{height:40px;margin-top:12px;margin-left:-4px}.opr-vote-btn-start,.opr-vote-btn-end{float:left;width:92px;height:40px;display:none}.opr-vote-btn-rank{background-position:0 0;width:85px;float:left;text-align:center;color:#7b423a}.opr-vote-btn-rank a{color:#7b423a;text-decoration:none;padding-top:2px;position:relative;top:2px}.opr-vote-btn-rank a:hover{text-decoration:underline}.opr-vote-cur{%*i*%}rank{font-weight:bold;color:#c03320;margin-top:-3px}.opr-vote-btn-start{outline:0;font-size:23px;text-decoration:none;color:#fff;text-align:center;line-height:36px;cursor:pointer;margin-left:-1px;font-family:"Microsoft YaHei",微软雅黑}.opr-vote-btn-start:link{background-position:-102px 0}.opr-vote-btn-start:visited{background-position:-102px 0}.opr-vote-btn-start:hover{background-position:-0 -50px}.opr-vote-btn-start:active{background-position:-102px -50px}.opr-vote-btn-end{background-position:-236p{%*i*%}x -50px;color:#fff;text-align:center;padding-top:2px;margin-left:-1px}.opr-vote-btn-end-text{font-size:15px;font-family:"Microsoft YaHei",微软雅黑}.opr-vote-btn-end-subend{line-height:12px;font-size:12px}.opr-vote-share-box{height:22px;margin-top:9px;cursor:pointer;position:relative;display:none}.opr-vote-sharebtn{background-position:-232px 0;width:45px;height:20px;line-height:20px;padding-left:10px;position:relative;float:left;overflow:hidden}.opr-vote-share-icon{display:inline-block;width:7px;heig{%*i*%}ht:4px;left:42px;position:absolute;top:8px;overflow:hidden}.opr-vote-sharebtn.opr-vote-sharebtn-down .opr-vote-share-icon{background-position:-298px 0}.opr-vote-sharebtn.opr-vote-sharebtn-up .opr-vote-share-icon{background-position:-298px -4px}.opr-vote-more{float:left;margin-left:4px}.opr-vote-morelink{display:inline-block;color:#7b423a;font-size:13px}.opr-vote-container #bdshare{border:1px solid #bbb;display:none;margin-top:-1px;background:#fff;padding:3px 4px;box-shadow:1px 1px 1px rgba(0,0,0{%*i*%},0.1)}.opr-vote-bdshare-fillbox{height:38px;display:none}.container_l .opr-vote-container{width:418px;padding-left:22px}.container_l .opr-vote-title{padding-left:0}.container_s .opr-vote-container{width:258px;padding-left:12px}.container_s .opr-vote-title{padding-left:10px}.container_l .opr-vote-rule{margin-left:75px}.container_s .opr-vote-rule{margin-left:65px}</style><div class="opr-vote-container c-abstract"> <div class="opr-vote-head-icon"></div><div class="opr-vote-head"> <div class="opr-vo{%*i*%}te-title">{%$tplData.title%}</div> {%if $tplData.rule[0].text%}<a class="opr-vote-rule" href="{%$tplData.rule[0].url%}" target="_blank">{%$tplData.rule[0].text%}</a>{%/if%} <div style="clear:both"></div> </div> <div class="opr-vote-flipboard-container"> <div class="opr-vote-flipboard"> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> <div><span></span></div> </div> <span>票</span> <div style="clear:both"></div> </div> <div class="opr-vote-rank-container"> <div class="opr-vote-btn-rank"> {%if $tplData.rank[0]['url']%}<a href="{%$tplData.rank[0]['url']%}" target="_blank">{%/if%}{%$tplData.rank[0]['text']|escape%}{%if $tplData.rank[0]['url']%}</a>{%/if%}<br /> <div class="opr-vote-currank">&nbsp;</div> </div> <a href="#" onclick="return false;" hidefocus="true" class="opr-vote-btn-start"> {%$tplData.btn[0]['start']|escape%} </a> <div class="opr-vote-btn-end"> <div class="opr-vote-btn-end-text">{%$tplData.btn[0]['end']|escape%}</div><div class="opr-vote-btn-end-subend">{%$tplData.btn[0]['subend']|escape%}</div> </div> <div style="clear:both"></div> </div> <div class="opr-vote-share-box"> <div class="opr-vote-sharebtn opr-vote-sharebtn-down">分享<div class="opr-vote-share-icon"></div></div> {%if $tplData.more[0]['text']%}<div class="opr-vote-more"><a href="{%$tplData.more[0]['url']%}" class="opr-vote-morelink" target="_blank">{%$tplData.more[0]['text']|escape%}</a></div>{%/if%} <div style="clear:both"></div>  <div id="bdshare" class="bdshare_t bds_tools get-codes-bdshare" data="{'text':'{%$tplData.share|escape%}'}"> <a class="bds_qzone"></a> <a class="bds_tsina"></a> <a class="bds_tieba"></a> <a class="bds_tqq"></a> <a class="bds_douban"></a> <a class="bds_renren"></a> </div> <script type="text/javascript" id="bdshare_js" data="type=tools" ></script> <script type="text/javascript" id="bdshell_js"></script>  </div> </div><script >
    A.setup({              
        'playername':'{%$tplData.playername|escape:'javascript'%}'        
    });
</script><script>A.init(function(){var T = A.baidu, _this = this;var container = _this.qq('opr-vote-container');var flipboard = _this.qq('opr-vote-flipboard');var btnstart = _this.qq('opr-vote-btn-start');var btnend = _this.qq('opr-vote-btn-end');var sharebox = _this.qq('opr-vote-share-box');var btnshare = _this.qq('opr-vote-sharebtn');var sharefillbox = _this.qq('opr-vote-bdshare-fillbox');var rankNum = _this.qq('opr-vote-currank');var con = _this.container; var playername = T.string.trim(_this{%*i*%}.data.playername); var accessToken = '';var geturl = 'https://openapi.baidu.com/rest/2.0/tieba/v1/superboy/player?player_name='+encodeURIComponent(playername);var sendurl = 'https://openapi.baidu.com/rest/2.0/tieba/v1/superboy/vote?player_id=#{playerid}&';var gentokenurl = 'http://dev.open.baidu.com/gentoken.php?';var loadedShare = false;var flipTime = 1000;var limit = 3600;var serverTime = bds.comm.serverTime;setInterval(function(){serverTime++;},1000);A.use('jquery', function(){var $ = jQuery {%*i*%}= A.ui.jquery; var $con = $(con);var $btnstart = $(btnstart);var $btnend = $(btnend);var $sharebox = $(sharebox);var $btnshare = $(btnshare);var $container = $(container);var $bdshare = $con.find('#bdshare');var $sharefillbox = $(sharefillbox);var $flipboard = $(flipboard);var $rankNum = $(rankNum);var storage;var votes = 0;var ranks = 0;var preVotes = 0;var prevRanks = 0;var playerid;var fb; var $shareTag = $con.find('#bdshell_js');initFlipboardPlugin();initVote();bindEvent();setTimeout(functio{%*i*%}n(){loadShareScript();},5000);function initVote(){A.use('localstorage', function() {storage = A.ui.localstorage({fileName : 'bd_right_vote_chinavoice',expiresDay : 7});storage.init(); getVote();});}function getStorageObject(k){var v = storage.get(k);var obj = {};if(v){try{ obj = T.json.parse(v); }catch(e){}}return obj;}function getVote(){T.sio.callByServer(gentokenurl+'baiduid='+encodeURIComponent(T.cookie.get('BAIDUID')), function(tokendata){if(tokendata.status == 0){accessToken = tokendata.con{%*i*%}tent;T.sio.callByServer(geturl+'&access_token='+encodeURIComponent(accessToken), function(data){ if(data && data.errno === 0 && data.errmsg == 'success' && data.ret){var ret = data.ret; if(ret && ret.length != 0 && ret.player_id){votes = ret.vote_number;ranks = ret.player_rank; playerid = ret.player_id;if(check(playerid)){ allow();}else{forbid(); }renderRanksAndVotes(ranks, votes);}else{renderRanksAndVotes(0, 0);forbid();} }else{renderRanksAndVotes(0, 0);forbid();}});}else{renderRanksAndVotes(0,{%*i*%} 0);forbid();}});}function check(playerid){ var cv = getStorageObject('chinavoice');var player = cv['player'+playerid];if(player){preVotes = player.votes;prevRanks = player.ranks;if(player.votetime && (serverTime-player.votetime) <= limit){return false;}else{return true;}}else{return true;} }function renderRanksAndVotes(ranks, votes){ranks = (prevRanks && ((ranks && ranks < prevRanks) || !ranks)) ? prevRanks : ranks || 0;votes = (preVotes && ((votes && votes < preVotes) || !votes)) ? preVotes : {%*i*%}votes || 0; fb = $flipboard.flipBoard({flipStep: '25px',flipTime: flipTime });setTimeout(function(){ fb.flip(votes); },0);$rankNum.html(ranks);}function vote(){if($flipboard.data('fliped')){votes++; if(playerid){ T.sio.callByServer(T.format(sendurl+'cookie='+encodeURIComponent(T.cookie.get('BAIDUID'))+'&access_token='+encodeURIComponent(accessToken), {'playerid': playerid}), function(data){ if(data && data.errno==0){fb.flip(votes);var cv = getStorageObject('chinavoice');cv['player'+playerid] = {{%*i*%}'votetime': serverTime, 'votes': votes, 'ranks': ranks};storage.set('chinavoice', T.json.stringify(cv));forbid();}});}}}function forbid(){$btnstart.css('display','none');$btnend.show();$sharebox.show();}function allow(){$btnstart.css('display','inline-block');$btnend.hide();$sharebox.hide();} function bindEvent(){$btnstart.click(function(){ vote(); });$btnshare.click(function(){loadShareScript();$btnshare.toggleClass('opr-vote-sharebtn-down opr-vote-sharebtn-up');$bdshare.toggle(); });} function{%*i*%} loadShareScript(){if(!loadedShare){$shareTag.get(0).src = "http://share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);loadedShare = true;} }function initFlipboardPlugin(){(function($) {var div = document.createElement('div'),rposition = /([^ ]*) (.*)/;if (div.style.backgroundPositionX !== '') {$(['X', 'Y']).each(function( i, letter ) {var property = 'backgroundPosition'+letter,isX = letter == 'X';$.cssHooks[property] = {set: function( elem, value ) {var current = {%*i*%}elem.style.backgroundPosition;elem.style.backgroundPosition = (isX? value + ' ' : '' ) + (current? current.match(rposition)[isX+1] : '0') + (isX? '' : ' ' + value);},get: function( elem, computed ) {var current = computed?$.css( elem, 'backgroundPosition' ):elem.style.backgroundPosition;return current.match(rposition)[!isX+1];}};$.fx.step[property] = function( fx ) {$.cssHooks[property].set( fx.elem, fx.now + fx.unit );}});}div = null;})(jQuery);(function($){$.fn.extend({flipBoard: function(opti{%*i*%}ons){var opt = {flipStep: '25px', flipTime: 1400};$.extend(opt, options);var $this = $(this);var $flipBoxes = $this.find("div");var flipLength = $flipBoxes.length;var $flips = $this.find("span"); var step = parseInt(opt.flipStep);function parseFlips(flips){flips = flips || 0;flips = '' + Math.abs(parseInt(flips));if(flips.length < flipLength){flips = Array(flipLength - flips.length + 1).join('0') + flips;}return flips.split('');}var callback = function(){};return {get: function(){return $this;},{%*i*%}init: function(flips){flips = parseFlips(flips);$.each(flips, function(i, n){var $f = $flips.eq(i); n && $f.css('background-position-y', '-' + n*step + 'px');$f.data('flipNum', n);});},flip: function(flips){flips = parseFlips(flips);$.each(flips, function(i ,n){$this.data('fliped', false);n = parseInt(n);var $f = $flips.eq(i);var flipNum = $f.data('flipNum') || 0;$f.css('backgroundPositionY', '-' + flipNum*step + 'px');var r = n - flipNum;var absr = Math.abs(r);if(r != 0){var move = '-=' + ( r >{%*i*%} 0 ? (absr * step) : ((10 - flipNum + n) * step) ) + 'px';$f.animate({backgroundPositionY: move}, opt.flipTime, function(){$f.data('flipNum', n);});}setTimeout(function(){$this.data('fliped', true);}, opt.flipTime);}); }};}});})(jQuery);}});});</script>{%/block%}
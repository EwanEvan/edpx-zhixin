{%extends 'c_base.tpl'%} {%block name="data_modifier"%}{%* 计算日期 *%}{%$today = time()|date_format:'%Y-%m-%d'%}{%$selectday = $tplData.selectday%}{%if !$selectday%}{%$selectday = $today%}{%/if%}{%$selectday = explode( '-', $selectday)%}{%/block%}{%block name='content'%}<style data-merge>{%fe_fn_c_css css='btn'%}{%fe_fn_c_css css='dropdown2'%}.op-calendar-new-box{border:2px solid #57abff;border-right:0;height:405px;position:relative;z-index:1}.op-calendar-new-year-box,.op-calendar-new-month-box,.op-calendar-new-holiday-box{float:left}.op-calendar-new-year-box,.op-calendar-new-month-box{margin-right:8px}.op-calendar-new-year-box{width:90px}.op-calendar-new-month-box{width:65px;padding:0 22px;position:relative;z-index:1}.op-calendar-new-holiday-box{width:107px}.op-calendar-new-select-box{height:26px;float:left;zoom:1;visibility:hidden}{%*i*%}.op-calendar-new-backtoday{float:right}.op-calendar-new-left{padding:10px;width:426px;position:absolute;z-index:1;left:0}.op-calendar-new-right{color:#fff;text-align:center;margin-left:446px;height:407px;background:#5caeff;background:-webkit-gradient(linear,0 0,0 100%,from(#5af),to(#73b9ff));background:-moz-linear-gradient(top,#5af,#73b9ff)}.op-calendar-new-table-box{float:left;width:100%}.op-calendar-new-month-box .c-dropdown2-btn-icon-border{border-color:transparent;background-color:transparen{%*i*%}t!important}.op-calendar-new .c-dropdown2 .c-dropdown2-btn-icon{padding-left:0}.op-calendar-new-prev-month,.op-calendar-new-next-month{position:absolute;top:0;display:block;width:21px;border:1px solid #999;border-bottom-color:#d8d8d8;background:#fafafa;height:28px;text-align:center;line-height:28px;text-decoration:none;color:#7a7a7a;font-weight:bold;font-family:Simsun,Simhei,sans-serif;z-index:205}.op-calendar-new-prev-month{left:0;border-right-color:#d8d8d8}.op-calendar-new-next-month{right:0;b{%*i*%}order-left-color:#d8d8d8}.op-calendar-new-prev-month:hover,.op-calendar-new-next-month:hover{color:#389cff;border-color:#389cff;border-left:1px solid #389cff}.op-calendar-new-table{width:100%;border-collapse:collapse;border-spacing:0}.op-calendar-new-table th,.op-calendar-new-table td{text-align:center;height:60px;border-top:1px solid #c8cacc;padding:0}.op-calendar-new-relative{position:relative;width:100%;zoom:1}.op-calendar-new-table th{height:37px;border-color:#5af;font-weight:normal;font-siz{%*i*%}e:1.08em}.op-calendar-new-table-six td{height:50px}.op-calendar-new-table td a{display:block;width:54px;border-right:1px solid #fff;height:38px;padding:11px 3px 10px;text-align:center;text-decoration:none;line-height:1;white-space:nowrap;overflow:hidden}.op-calendar-new-table td a *{cursor:pointer}.op-calendar-new-table-six td a{padding:6px 3px}.op-calendar-new-table td .op-calendar-new-table-selected,.op-calendar-new-table td .op-calendar-new-table-border{padding:8px 0 7px;width:54px;border:3px{%*i*%} solid #fb0}.op-calendar-new-table-six td .op-calendar-new-table-selected,.op-calendar-new-table-six td .op-calendar-new-table-border{padding:3px 0}.op-calendar-new-daynumber{display:block;height:22px;font-size:1.38em;color:#000}.op-calendar-new-table-almanac{display:block;color:#999;font-size:.92em}.op-calendar-new-table-festival .op-calendar-new-table-almanac{color:#e02d2d}th.op-calendar-new-table-weekend,.op-calendar-new-table-weekend .op-calendar-new-daynumber{color:#e02d2d}.op-calendar-new-{%*i*%}table-other-month .op-calendar-new-daynumber,.op-calendar-new-table-other-month .op-calendar-new-table-almanac{color:#bfbfbf}.op-calendar-new-table-today .op-calendar-new-daynumber,.op-calendar-new-table-today .op-calendar-new-table-almanac{color:#fff}.op-calendar-new-table-today{background:#fb0}.op-calendar-new-table td .op-calendar-new-table-rest,.op-calendar-new-table td .op-calendar-new-table-work{background:#fff0f0}.op-calendar-new-table td .op-calendar-new-table-work{background:#f5f5f5}.op{%*i*%}-calendar-new-table-holiday-sign{position:absolute;left:0;top:0;display:block;width:17px;height:17px;color:#fff;background:#f43;text-align:left;text-indent:1px;line-height:1.08;overflow:hidden}.op-calendar-new-table-work .op-calendar-new-table-holiday-sign{background:#969799}.op-calendar-new-table-other-month .op-calendar-new-table-holiday-sign{filter:alpha(opacity = 50);opacity:.5}.op-calendar-new-right-date{height:48px;line-height:48px}.op-calendar-new-right-day{position:relative;width:75px;he{%*i*%}ight:75px;margin:0 auto;line-height:76px;font-size:52px;background:#fb0;border-radius:3px;box-shadow:1px 2px 5px rgba(0,0,0,0.1),-1px 2px 5px rgba(0,0,0,0.1)}.op-calendar-new-right-lunar span{display:block}.op-calendar-new-right-almanac{margin:10px auto 0;width:125px;border-top:2px solid #94c9ff;padding-top:10px;line-height:18px;height:155px}.op-calendar-new-right-almanac span{display:block;width:62px;float:left;white-space:nowrap;overflow:hidden}.op-calendar-new-right-almanac i{display:block;wi{%*i*%}dth:30px;height:30px;margin:0 auto 5px}.op-calendar-new-right-almanac i,.op-calendar-hover-suit i,.op-calendar-hover-avoid i{font-style:normal;font:24px/30px 'Microsoft Yahei';text-shadow:2px 2px 1px rgba(0,0,0,0.1);text-align:center;color:#fff}.op-calendar-new-right-hover .op-calendar-hover-almanac{display:block}.op-calendar-hover-almanac{display:none;position:absolute;z-index:100;width:210px;right:-231px;top:198px;background:#fff;padding:15px 10px;border:1px solid #5fafff;color:#333;box-shadow{%*i*%}:4px 4px rgba(0,0,0,0.05);z-index:100}.op-calendar-almanac-arrow{position:absolute;top:20px;left:-11px;font:22px Simsun;color:#fff;text-shadow:0 -1px rgba(0,0,0,0.05);z-index:1}.op-calendar-hover-suit,.op-calendar-hover-avoid{padding-left:40px;position:relative;display:block;min-height:30px;_height:30px;text-align:left}.op-calendar-hover-suit i,.op-calendar-hover-avoid i{display:block;position:absolute;top:0;left:0;width:30px;height:30px;background:#67b3ff}.op-calendar-hover-avoid i{background:#{%*i*%}ff5040}.op-calendar-new-holidaytip{display:none;position:relative;background:#f7f7f7;padding:10px 10px 10px 0}.op-calendar-new-holidaytip p{margin-left:35px}.op-calendar-new-holidaytip-icon{position:absolute;left:0;top:5px;padding-left:10px;width:20px;height:20px;text-align:center;font:30px/30px Simsun;color:#61b0ff}.op-calendar-new-holidaytip-icon i{font-style:normal;font:14px/30px Tahoma,Arial;position:absolute;width:20px;height:20px;right:0;top:0}.op-calendar-new-holidaystyle .op-calendar-new{%*i*%}-box,.op-calendar-new-red-bg .op-calendar-new-box{border-color:#cb1c18}.op-calendar-new-holidaystyle .op-calendar-new-right,.op-calendar-new-red-bg .op-calendar-new-right{color:#fff;text-align:center;margin-left:446px;height:407px;background:#cb1c18;background:-webkit-gradient(linear,0 0,0 100%,from(#cb1c18),to(#f44f23));background:-moz-linear-gradient(top,#cb1c18,#f44f23)}.op-calendar-new-holidaystyle .op-calendar-new-right-almanac,.op-calendar-new-red-bg .op-calendar-new-right-almanac{border-t{%*i*%}op-color:#eb7563}.op-calendar-new-holidaystyle .op-calendar-new-table th,.op-calendar-new-red-bg .op-calendar-new-table th{border-color:#f55c4e}.op-calendar-new-holidaystyle .op-calendar-hover-almanac,.op-calendar-new-red-bg .op-calendar-hover-almanac{border-color:#cb1c18}</style><div class="op-calendar-new {%if $tplData.showHoliday%}op-calendar-new-holidaystyle{%/if%}"> <div class="op-calendar-new-box"> <div class="op-calendar-new-left c-clearfix"> <div class="op-calendar-new-select-box"> <div class="op-calendar-new-year-box"></div> <div class="op-calendar-new-month-box"> <a href="javascript:;" class="op-calendar-new-prev-month" hidefocus="true" onclick="return false">&lt;</a> <a href="javascript:;" class="op-calendar-new-next-month" hidefocus="true" onclick="return false">&gt;</a> </div> <div class="op-calendar-new-holiday-box"></div> </div> {%* 返回今天 *%} <a class="c-btn op-calendar-new-backtoday OP_LOG_BTN" hidefocus="true" data-click="{fm:'beha'}" href="javascript:;">返回今天</a> {%* 日期表格容器 *%} <div class="op-calendar-new-table-box c-gap-top"> {%* 这里 table 的作用是为了让首屏显的不是很空旷 *%} <table class="op-calendar-new-table"> <tr><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th class="op-calendar-new-table-weekend">六</th><th class="op-calendar-new-table-weekend">日</th></tr> </table> </div> </div> {%* 农历信息 *%} <div class="op-calendar-new-right"></div> </div> <div class="op-calendar-new-holidaytip"></div></div><script >
    A.setup({
        data: {%json_encode($tplData)%},
        curDate: '{%$today|escape:'javascript'%}',
        selectDate: {%json_encode( $selectday )%},
        srcid: '{%$extData.resourceid%}'
    });
</script><script data-merge>A.setup(function(){var _this = this,timer1,timer2,dropDown,curDate = _this.data.curDate,selectDate = _this.data.selectDate.join('-'),srcid = 6018,data = _this.data.data,showHoliday = data.showHoliday,tableBox = _this.find('.op-calendar-new-table-box')[0],rightBox = _this.find('.op-calendar-new-right')[0],dropDownBox = _this.find('.op-calendar-new-select-box')[0],backTodayBtn = _this.find('.op-calendar-new-backtoday')[0],holidayTip = _this.find('.op-calendar-new-holida{%*i*%}ytip')[0],prevMonth = _this.find('.op-calendar-new-prev-month')[0],nextMonth = _this.find('.op-calendar-new-next-month')[0],container = _this.find('.op-calendar-new')[0],format,ensureDateStr,holidayStyle = 'op-calendar-new-holidaystyle';ensureDateStr = function( str ) {return str.split( /-0?/ ).join( '-' );};format = function( str, obj ) {return str.replace( /#{([^}]+)}/g, function( match, ret ) {return obj[ ret ] || '';});};A.use( 'dropdown21', function() {A.use( 'lunar', function() {var lunar {%*i*%}= A.ui.lunar,Calendar,dataCache,getDateInfo,setHolidayStyle;setHolidayStyle = function( flag ) {var con = $( container );con.toggleClass( holidayStyle, !!flag );};getDateInfo = function( date ) {var ret;if ( typeof date === 'string' ) {ret = date.split( /-0?/ );date = new Date( ret[0], ret[1] - 1, ret[2] );} else {ret = [ date.getFullYear(), date.getMonth() + 1, date.getDate() ];}return {year: ret[0],month: ret[1],date: ret[2],yearMonth: ret.slice( 0, 2 ).join( '-' ),dateStr: ret.join( '-' ),dat{%*i*%}eStrZero: [ ret[0], ( '0' + ret[1] ).slice( -2 ), ( '0' + ret[2] ).slice( -2 ) ].join( '-' ),Date: date}};selectDate = getDateInfo( selectDate );dataCache = ({init: function() {var dataTime = selectDate;this.set( data, dataTime.year, dataTime.yearMonth );return this;},set: function( data, year, yearMonth ) {var arr = function( obj ) {return obj || [];};this.setHoliday( arr( data.holidaylist ) , year );this.setAlmanac( arr( data.almanac ), yearMonth );this.setHolidayDateList( arr( data.holiday ),{%*i*%} yearMonth );this.setMod( arr( data.day ), yearMonth );},_holiday: {},getHoliday: function( year ) {return this._holiday[ year ];},setHoliday: function( dataList, year ) {var ret = {}, i, l, tem;if ( this._holiday[ year ] ) {return;}for ( i = 0, l = dataList.length; i < l; i++ ) {ret[ dataList[i].name ] = {};}this._holiday[ year ] = ret;},_holidayDateList: {},_festival: {},setHolidayDateList: function( holidayList, yearMonth ) {var ret = {},year = yearMonth.split('-')[0],tem, i, j, k, l, holiday{%*i*%}Obj, festivalObj;if ( this._holidayDateList[ yearMonth ] ) {return;}if ( !holidayList.length && holidayList.festival ) {holidayList = [ holidayList ];}!this._holiday[ year ] && ( this._holiday[ year ] = {} );!this._festival[ year ] && ( this._festival[ year ] = {} );for ( i = 0, l = holidayList.length; i < l; i++ ) {tem = holidayList[ i ];holidayObj = this._holiday[ year ][ tem.name ] || {};if ( getDateInfo( tem.festival ).year == year ) {$.extend( holidayObj, tem );this._festival[ year ][ tem.f{%*i*%}estival ] = tem.name;}tem = tem.list;for ( j = 0, k = tem.length; j < k; j++ ) {ret[ tem[ j ].date ] = tem[ j ].status;tem[ j ] = getDateInfo( tem[ j ].date ).dateStrZero;}holidayObj.startday = ensureDateStr( tem.sort()[0] );}this._holidayDateList[ yearMonth ] = ret;},getHolidayDateList: function( yearMonth ) {return this._holidayDateList[ yearMonth ];},getFestival: function( year ) {return this._festival[ year ];},_almanac: {},getAlmanac: function( yearMonth ) {return this._almanac[ yearMonth ]{%*i*%};},setAlmanac: function( dataList, yearMonth ) {if ( this._almanac[ yearMonth ] ) {return;}var list = this._almanac[ yearMonth ] = {},i,l;for ( i = 0, l = dataList.length; i < l; i++ ) {list[ ensureDateStr( dataList[i].date ) ] = {suit: dataList[i].suit.replace(/\.$/,'').split('.').slice( 0, 15 ),avoid: dataList[i].avoid.replace(/\.$/,'').split('.').slice( 0, 15 )}}},_mod: {},setMod: function( modList ) {var mod = this._mod, i, l;for ( i = 0, l = modList.length; i < l; i++ ) {mod[ modList[ i ].d{%*i*%}ate ] = modList[ i ]; }},getMod: function() {return this._mod;},getData: function( yearMonth, callback ) {if ( this._almanac[ yearMonth ] ) {callback.call( this );} else {yearMonth = yearMonth.split( '-' );this.ajax( yearMonth[0] + '年' + yearMonth[1] + '月', callback, function() {return yearMonth.join( '-' );});}},getHolidayData: function( year, name, callback ) {var holiday = this.getHoliday( year );if ( holiday && holiday[ name ].festival ) {callback.call( this );} else {this.ajax( year + '年' +{%*i*%} name, callback, function( data ) {var holiday = data.holiday, i, l;if ( holiday && !holiday.length ) {holiday = [ holiday ];}for ( i = 0, l = holiday.length; i < l; i++ ) {if ( holiday[ i ].name == name ) {return getDateInfo( holiday[ i ].festival ).yearMonth;}}});}},ajax: function( query, callback, fn ) {var self = this;_this.ajax( query, srcid, {success: function( data ) {var yearMonth;data = data[0] || {};yearMonth = fn( data );if ( !yearMonth ) {return;}self.set( data, yearMonth.split('-')[{%*i*%}0], yearMonth );callback.call( self );}});}}.init());Calendar = function( curDate, container, holidayTip) {var date,month,year,RESTClass = 'op-calendar-new-table-rest',WORKClass = 'op-calendar-new-table-work',WEEKENDClass = 'op-calendar-new-table-weekend',FESTIVALClass = 'op-calendar-new-table-festival',TODAYClass = 'op-calendar-new-table-today',OTHERMONTHClass = 'op-calendar-new-table-other-month',SELECTEDClass = 'op-calendar-new-table-selected',TODAYBORDERClass = 'op-calendar-new-table-border'{%*i*%},doubleDate,buildTable,countDate,setCurDate,showLunar,selectedObj,setDate,monthChangeEvent = function() {},selectClass,cutWord,toggleHolidayTip,weekWord = '<tr>{一}{二}{三}{四}{五}{!六}{!日}</tr>',oneDay = 1000 * 24 * 60 * 60;weekWord = weekWord.replace(/\{\!?|\}/g, function( match ) {return match == '{' ? '<th>' : ( match == '{!' ? '<th class="' + WEEKENDClass + '">' : '</th>' );});doubleDate = function( str ) {return ( '0' + str ).slice( -2 );};cutWord = function( str, len) {var count = i = 0, code;w{%*i*%}hile( str.charCodeAt( i ) ) {code = str.charCodeAt( i ) > 255 ? 2 : 1;if ( (code + count) > len ) {return str.slice( 0, --i ) + '...';}count += code;i ++;}return str.slice( 0, i );};setCurDate = function( dateObj ) {year = dateObj.year;month = dateObj.month;date = dateObj.date;};curDate = ensureDateStr( curDate );showLunar = function( dateInfo ) {var date = dateInfo.Date,lunarInfo = lunar( date ),buildAlmanacInfo,mod = dataCache.getMod()[ dateInfo.dateStr ] || {},almanacInfo = dataCache.getAlman{%*i*%}ac( dateInfo.yearMonth ) || {},info = almanacInfo[ dateInfo.dateStr ] || {},almanacBox,suit = info.suit || [],avoid = info.avoid || [],tpl = '<p class="op-calendar-new-right-date">#{date}</p>\<p class="op-calendar-new-right-day">#{day}</p>\<p class="op-calendar-new-right-lunar c-gap-top-small">\<span>#{lunarMonth}</span><span>#{lunarYear}</span><span>#{lunarDate}</span>\</p>',almanacTpl = '<div class="op-calendar-new-right-almanacbox">\<p class="op-calendar-new-right-almanac c-clearfix">\<span c{%*i*%}lass="op-calendar-new-right-suit"><i>宜</i>#{suit}</span>\<span class="op-calendar-new-right-avoid"><i>忌</i>#{avoid}</span>\</p>\<p class="op-calendar-hover-almanac">\<span class="op-calendar-almanac-arrow">◆</span>\<span class="op-calendar-hover-suit"><i>宜</i>#{suitAll}</span>\<span class="op-calendar-hover-avoid c-gap-top"><i>忌</i>#{avoidAll}</span>\</p>\</div>',rightHtml;buildAlmanacInfo = function( arr, length ) {return arr && arr.length ? arr.slice( 0, length ).join('<br />') : '';};rightHtm{%*i*%}l = format( tpl, {date: dateInfo.dateStrZero + ' 星期' + lunarInfo.cnDay,day: dateInfo.date,lunarMonth: mod.lunarmonth || ( lunarInfo.lMonth.replace( '十二', '腊' ) + '月' + lunarInfo.lDate ),lunarYear: mod.lunaryear || ( lunarInfo.gzYear + '年 【' + lunarInfo.animal + '年】' ),lunarDate: mod.lunardate || ( lunarInfo.gzMonth + '月 ' + lunarInfo.gzDate + '日' )});rightHtml += format( almanacTpl, {suit: buildAlmanacInfo( suit, 5 ),avoid: buildAlmanacInfo( avoid, 5 ),suitAll: suit.join('、'),avoidAll: avoid.joi{%*i*%}n('、')});rightBox.innerHTML = rightHtml;if ( suit.length + avoid.length > 0 ) {almanacBox = _this.find('.op-calendar-new-right-almanacbox');almanacBox.on( 'mouseover', function() {clearTimeout( timer1 );timer1 = setTimeout(function() {almanacBox.addClass( 'op-calendar-new-right-hover' );}, 300 );});almanacBox.on( 'mouseout', function() {clearTimeout( timer1 );timer1 = setTimeout(function() {almanacBox.removeClass( 'op-calendar-new-right-hover' );}, 100 );});}};buildTable = function( startDate, e{%*i*%}ndDate, selectedDate ) {var ret = [],holidayList = dataCache.getHolidayDateList( getDateInfo( selectedDate ).yearMonth ),modList = dataCache.getMod(),flag = 1,tableClass = '',mod,classname,dateObj,almanac,festival,rest,tdTpl,tableWord,temDate,cutTableWord;if ( ( endDate - startDate ) / oneDay < 28 ) {endDate = new Date( endDate.getTime() + oneDay * 7 );} tdTpl = '<td>\<div class="op-calendar-new-relative">\<a href="javascript:;" #{title} data-click="{fm:\'beha\'}" hidefocus="true" class="#{class{%*i*%}name}" date="#{date}">\#{rest}\<span class="op-calendar-new-daynumber">#{day}</span>\<span class="op-calendar-new-table-almanac">#{almanac}</span>\</a>\</div>\</td>';while ( startDate <= endDate ) {if ( flag > 42 ) {break;}dateObj = getDateInfo( startDate );classname = [];rest = '';almanac = lunar( startDate );festival = almanac.festival();mod = modList[ dateObj.dateStr ] || {};if ( holidayList[ dateObj.dateStr ] ) {rest = '<span class="op-calendar-new-table-holiday-sign">#{text}</span>';if ( ho{%*i*%}lidayList[ dateObj.dateStr ] == '1' ) {classname.push( RESTClass );rest = format( rest, { text: '休' } );} else if ( holidayList[ dateObj.dateStr ] == '2' ) {classname.push( WORKClass );rest = format( rest, { text: '班' } );} else {classname.push( RESTClass );rest = '';}}if ( ( flag + 1 ) % 7 == 0 || flag % 7 == 0 ) {classname.push( WEEKENDClass );}if ( festival.length || almanac.term || ( mod.red && mod.red == '1' ) ) {classname.push( FESTIVALClass );}if ( dateObj.dateStr == curDate ) {if ( holid{%*i*%}ayList[ dateObj.dateStr ] ) {classname.push( TODAYBORDERClass );} else {classname.push( TODAYClass );}}if ( dateObj.month != month ) {classname.push( OTHERMONTHClass );}if ( dateObj.dateStr == selectedDate ) {classname.push( SELECTEDClass );}flag % 7 == 1 && ret.push( '<tr>' );tableWord = mod.tableword || ( festival.length ? festival[ 0 ].desc.replace( /国际|世界/, '' ) : ( almanac.term || almanac.lDate ) );cutTableWord = cutWord( tableWord, 8 );ret.push( format( tdTpl, {classname: classname.join( '{%*i*%} ' ),day: dateObj.date,almanac: cutTableWord,date: dateObj.dateStr,rest: rest,title: cutTableWord == tableWord ? '' : (' title="' + tableWord + '"')}));flag % 7 == 0 && ret.push( '</tr>' );startDate = new Date( oneDay + startDate.getTime() );flag ++;}if ( flag > 36 ) {tableClass = ' op-calendar-new-table-six';}return '<table class="op-calendar-new-table' + tableClass +'">' + weekWord + ret.join('') + '</table>';};countDate = function( date, holiday ) {var first, last, i, l;first = new Date( date{%*i*%}.getFullYear(), date.getMonth(), 1 );last = new Date( date.getFullYear(), date.getMonth() + 1, 1 );last = new Date( last.getTime() - oneDay );if ( holiday ) {first = getDateInfo( holiday ).Date;last = new Date( first.getTime() + oneDay * 28 );}return {startDate: new Date( first.getTime() - oneDay * ( (first.getDay() == 0 ? 7 : first.getDay()) - 1 ) ),endDate: new Date( last.getTime() + oneDay * ( 7 - ( last.getDay() == 0 ? 7 : last.getDay() ) ) )}};setDate = function( dateStr, holiday) {var date{%*i*%}Obj = getDateInfo( dateStr ),oldDate = getDateInfo( [ year, month, date ].join('-') ),dater,festival,festivalName;dataCache.getData( dateObj.yearMonth, function() {festival = dataCache.getFestival( dateObj.year );festivalName = festival[ dateObj.dateStr ] || null;if ( dateObj.year != year || dateObj.month != month ) {dater = countDate( dateObj.Date, holiday );setCurDate( dateObj );container.innerHTML = buildTable( dater.startDate, dater.endDate, dateStr );selectedObj = _this.find( '.' + SELECTED{%*i*%}Class )[0];monthChangeEvent( dateObj, oldDate, holiday );} setCurDate( dateObj );setHolidayStyle( festivalName );showLunar( dateObj );toggleHolidayTip( dataCache.getHoliday( year )[ festivalName ] );});};toggleHolidayTip = function( obj ) {var tpl;if ( !obj || ( !obj.desc && !obj.rest ) ) {holidayTip.style.display = 'none';} else {tpl = '<span class="op-calendar-new-holidaytip-icon">○<i>!</i></span>\<p>#{desc}</p>\<p>#{rest}</p>\</span>';holidayTip.style.display = 'block';holidayTip.innerHTML = {%*i*%}format( tpl, {desc: obj.desc,rest: obj.rest});}};$( container ).delegate( 'a', 'click', function( e ) {e.preventDefault();selectClass( this );setDate( this.getAttribute( 'date' ) );});selectClass = function( obj ) {selectedObj && $( selectedObj ).removeClass( SELECTEDClass );obj && $( obj ).addClass( SELECTEDClass );selectedObj = _this.find( '.' + SELECTEDClass )[0];};return {getDate: function() {return getDateInfo( [ year, month, date ].join( '-' ) );},nextMonth: function() {var nextMonthDaynum{%*i*%},curDate = this.getDate(),nnMonth,nDays,newDate,date;nnMonth = new Date( curDate.year, parseInt( curDate.month, 10 ) + 1, 1 );nDays = new Date( nnMonth - oneDay ).getDate();date = curDate.date < nDays ? curDate.date : nDays;newDate = getDateInfo( new Date( curDate.year, curDate.month, date ) );this.setDate( newDate.dateStr );},prevMonth: function() {var nDays,curDate = this.getDate(),newDate,date;nDays = new Date( ( new Date( curDate.year, curDate.month - 1, 1 ) - oneDay ) ).getDate();newDate = {%*i*%}getDateInfo( new Date( curDate.year, curDate.month - 2, curDate.date < nDays ? curDate.date : nDays ) );this.setDate( newDate.dateStr );},set: function( name, value ) {var curDate = this.getDate(),newDate;curDate[ name ] = value;newDate = getDateInfo( [ curDate.year, curDate.month, curDate.date ].join( '-' ) );if ( newDate.Date.getDate() != newDate.date ) {newDate = { dateStr: newDate.yearMonth + '-1' };}setDate( newDate.dateStr );return this;},setDate: function( dateStr  ) {setDate( dateStr );r{%*i*%}eturn this;},setHoliday: function( name, year ) {var self = this;dataCache.getHolidayData( year, name, function() {var holiday = this.getHoliday( year )[ name ];if ( !holiday ) {self.setHoliday( name, getDateInfo( curDate ).year );return;}month = null;setDate( ensureDateStr( holiday.festival ), ensureDateStr( holiday.startday ), true );toggleHolidayTip( holiday );});},backToday: function() {var evt = window.event || {};evt.returnValue = false;month = null;this.setDate( curDate );return this;},ad{%*i*%}dMonthChangeEvent: function( fn, newDate, oldDate ) {var self = this;if ( typeof fn == 'function' ) {monthChangeEvent = function( newDate, oldDate, holiday ) {fn.call( self, newDate, oldDate, holiday );};}return this;}};};(function() {var calendar = Calendar( curDate, tableBox, holidayTip ),curYear = getDateInfo( curDate ).year,curHoliday = dataCache.getHoliday( selectDate.year ),defaultHoliday = showHoliday,defaultHolidayObj = curHoliday[ defaultHoliday ];dropDown = A.ui.dropdown21;var initDrop{%*i*%}Down,buildSelectHtml,yearOnOpen,isFirstOpen,yearBox,yearMenu,defaultHolidaySelect = { value: 'default', text: '假期安排', selected: 1},resetHoliday,holidayChange,yearSelect,monthSelect,holidaySelect;if ( defaultHoliday ) {calendar.setHoliday( defaultHoliday, getDateInfo( defaultHolidayObj.festival ).year, defaultHolidayObj.startday );} else {calendar.setDate( selectDate.dateStr );}initDropDown = function( data, defaultValue, box, onchange, onopen ) {var i, l, cache = [];if ( Object.prototype.toStrin{%*i*%}g.call( data ) != '[object Array]' ) {for ( i = data.min; i <= data.max; i ++ ) {cache.push( {value: i,text: i + data.unit,selected: i == defaultValue});}} else {cache = data;}return dropDown( cache, {appendTo: _this.find( '.' + box )[0],number: 12,onchange: onchange,onopen: onopen});};yearOnOpen = function( obj ) {var index, menuInner;if ( isFirstOpen ) {return;}isFirstOpen = true;index = obj.index;if ( index == 0 ) {return;}menuInner = $( '.c-dropdown2-menu-inner', yearBox )[0];menuInner.scrol{%*i*%}lTop = 0;timer2 = setInterval(function() {var scrollBar;if ( menuInner.scrollTop == 0 || !$( menuInner ).hasClass( 'opui-scroll-ctrl-content' ) ) {return;}clearInterval( timer2 );scrollBar = $( '.opui-scroll-ctrl-scroll', menuInner.parentNode )[ 0 ];timer2 = setInterval(function() {if ( scrollBar.style.cssText == '' ) {return;}menuInner.scrollTop = index * 26;clearInterval( timer2 );}, 10);}, 10);};yearSelect = initDropDown( {min: 1900,max: 2050,unit: '年'},selectDate.year, 'op-calendar-new-year-{%*i*%}box', function( obj ) {calendar.set( 'year', obj.item.value );},yearOnOpen);yearBox = _this.find( '.op-calendar-new-year-box' )[0];yearMenu = $( '.c-dropdown2-menu', yearBox )[0];yearMenu.style.left = '-9999px';yearSelect.open();yearSelect.close();yearMenu.style.left = '0';monthSelect = initDropDown( {min: 1,max: 12,unit: '月' }, selectDate.month, 'op-calendar-new-month-box',function( obj ) {calendar.set( 'month', obj.item.value );});holidayChange = function( obj ) {var value = obj.item.value;if {%*i*%}( value == 'default' ) {return;}calendar.setHoliday( value, yearSelect.getValue() );};holidaySelect = initDropDown( [ defaultHolidaySelect ], 'default', 'op-calendar-new-holiday-box',holidayChange);resetHoliday = function( holidayList ) {holidaySelect.removeAll();holidaySelect.add( defaultHolidaySelect );for ( var name in holidayList ) {if ( holidayList.hasOwnProperty( name ) ) {holidaySelect.add( { value: name, text: name } );}}};resetHoliday( curHoliday );holidaySelect.setValue( defaultHoliday{%*i*%} );dropDownBox.style.visibility = 'visible';calendar.addMonthChangeEvent(function( newDate, oldDate, holiday ) {var date = this.getDate(),yearLength = yearSelect.getLength();monthSelect.setIndex( date.month - 1 );if ( date.year - 1900 > ( yearLength - 1 ) ) {yearSelect.add( { value: yearLength + 1900, text: yearLength + 1900 + '年' } );}yearSelect.setIndex( date.year - 1900 );if ( !holiday ) {holidaySelect.setIndex( 0 );}if ( newDate.year != oldDate.year ) {resetHoliday( dataCache.getHoliday( new{%*i*%}Date.year ) );}});$( backTodayBtn ).click(function() {calendar.backToday(); });$( nextMonth ).click(function() {calendar.nextMonth();});$( prevMonth ).click(function() {calendar.prevMonth();});})();});});this.dispose = function(){clearTimeout( timer1 );clearInterval( timer2 );dropDown&&dropDown.dispose&&dropDown.dispose();};});</script>{%/block%}
{%extends 'c_base.tpl'%} {%$smarty.allow_php_tag=true%}{%block name="data_modifier"%} {%$extData.feData.hasShowURLGap = true%} {%$tplData.title=$tplData.titleDesc%} {%$tplData.url=$tplData.titleUrl%} {%function fe_fn_bus_tag_map tag=''%}{%$colors=['yellow', 'blue']%}{%$tempDataColor=$colors[1]%}{%if $tag=='路'%}{%$tempDataColor=$colors[1]%}{%/if%}{%$tempDataColor%}{%/function%} {%function fe_fn_bus_font_size_zoom str='' zoomMap=''%}{%$tempDataSize=13%}{%$strLength=preg_match_all("/./us", $str, $match)%}{%foreach $zoomMap as $item%}{%if $strLength<=$item@key%}{%$tempDataSize=$item%}{%break%}{%/if%}{%/foreach%}{%$tempDataSize%}{%/function%} {%function fe_fn_bus_font_size_zoom2 str='' zoomMap=''%}{%$tempDataSize=13%}{%$strLength=$str|string_display_len%}{%foreach $zoomMap as $item%}{%if $strLength<=$item@key%}{%$tempDataSize=$item%}{%break%}{%/if%}{%/foreach%}{%$tempDataSize%}{%/function%} {%$tempDataNumFontSizeZoomMap=['2'=> '60', '3'=> '46', '4'=> '36', '5'=> '30', '6'=> '26', '7'=> '20', '8'=> '16', '9'=> '14']%} {%$tempDataStartEndFontSizeZoomMap=['11'=> '24', '12'=> '22', '13'=> '20', '14'=> '18', '15'=> '17', '16'=> '16', '17'=> '15', '18'=> '14', '19'=> '13', '20'=> '13']%}{%*模板全局配置*%}{%*换乘线宽度*%}{%*间隔支撑块高度*%}{%*是否有分叉线路*%}{%$tplData.config=[
	'transferLineWidth' => 6,
	'middleSeperatorHeight' => 70,
	'lineBoxHeight' => 128,
	'hasCross' => ($tplData.lines[1] && count($tplData.lines[1])>0)
]%}{%if $tplData.config.hasCross%}{%$tplData.config.middleSeperatorHeight=40%}{%*
{%$cross1Start=$tplData.lines[0][0]['stopInfo'][0]['stopName']%}
{%$cross1End=end($tplData.lines[0][0]['stopInfo'])%}
{%$cross2Start=$tplData.lines[1][0]['stopInfo'][0]['stopName']%}
{%$cross2End=end($tplData.lines[1][0]['stopInfo'])%}
{%$arr=[$cross1Start, $cross1End['stopName'], $cross2Start, $cross2End['stopName']]%}
{%$repeat=[]%}
{%$repeatStop=''%}
{%foreach $arr as $item%}
	{%if $repeat[ord($item)]%}
		{%$repeatStop=$item%}
		{%break%}
	{%else%}
		{%$repeat[ord($item)]='true'%}
	{%/if%}
{%/foreach%}
*%}{%/if%}{%/block%}{%block name='content'%}{%*var_dump($tplData.lines)*%}{%*
正:<br>
{%foreach $tplData.lines[0][0]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
{%foreach $tplData.lines[1][0]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
反:<br>
{%foreach $tplData.lines[0][1]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
<hr>
{%foreach $tplData.lines[1][1]['stopInfo'] as $item%}
{%$item.stopName%}--
{%/foreach%}
*%}<style data-merge>.op-map-subway-info{border-collapse:collapse;border-spacing:0;color:#fff;width:100%}.op-map-subway-info td{height:74px;padding:12px;background-color:#389cff;vertical-align:top;font-family:"Microsoft YaHei",微软雅黑}.op-map-subway-info td.op-map-subway-info-right{*padding-top:16px}.op-map-subway-info td.op-map-subway-info-left{padding-right:0;vertical-align:middle}.op-map-subway-info-left{width:86px;text-align:center}.op-map-subway-info-right-container{position:relative;zoom:1}.o{%*i*%}p-map-subway-info-right-container a{color:#fff!important}.op-map-subway-info-num{height:48px;line-height:48px;padding-bottom:4px;margin:0 auto;font-family:arial}.op-map-subway-info-tag{width:68px;line-height:1.23em;font-size:1.23em;margin:0 auto}.op-map-subway-info-tag-blue{background-color:#2d90f2}.op-map-subway-info-tag-yellow{background-color:#ffb522}.op-map-subway-info-start-end{height:30px;font-size:1.38em;display:inline-block;padding-top:4px;border-collapse:collapse;border-spacing:0}.op-ma{%*i*%}p-subway-info-start-end td{height:auto;padding:0;line-height:auto}.op-map-subway-info-start-end td.op-map-subway-info-start{text-align:right;padding-right:8px}.op-map-subway-info-start-end td.op-map-subway-info-end{text-align:left;padding-left:8px}.op-map-subway-info-start-end td.op-map-subway-info-direction,.op-map-subway-info-switcher,.op-map-subway-stop-tail,.op-map-subway-line-stop-icon-text div,.op-map-subway-station-prev div,.op-map-subway-station-next div{background:url(http://www.baidu.c{%*i*%}om/aladdin/img/map_subway/map_bus.png) no-repeat;_background:url(http://www.baidu.com/aladdin/img/map_subway/map_bus.gif) no-repeat}.op-map-subway-info-start-end td.op-map-subway-info-direction{width:54px;display:inline-block;height:20px;background-position:0 5px}.op-map-subway-info-start-end td.op-map-subway-info-cross-direction-left{background-position:0 -18px;height:42px;width:62px}.op-map-subway-info-start-end td.op-map-subway-info-cross-direction-right{background-position:0 -56px;height:42p{%*i*%}x;width:62px}.op-map-subway-info-info span{display:inline-block;float:left;line-height:20px}.op-map-subway-info-starttime,.op-map-subway-info-endtime{width:108px}.op-map-subway-info-switcher-border{position:absolute;background:#fff;top:6px;background-position:-83px 6px;right:-1px;width:62px;height:24px;filter:alpha(opacity=60);opacity:.8}.op-map-subway-info-switcher{position:absolute;z-index:1;top:7px;right:0;width:36px;height:22px;background-position:-83px 6px;background-color:#389cff;padding-l{%*i*%}eft:24px;cursor:pointer}.op-map-subway-info-switcher-border-hover{filter:alpha(opacity=100);opacity:1}.op-map-subway-info-link{position:absolute;bottom:1px;right:0;color:#fff}.op-map-subway-station-container{position:relative;border:2px solid #389cff;background-color:#fff;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-o-user-select:none;user-select:none}.op-map-subway-stop{float:left;width:26px;height:108px;text-align:center;font-family:"Microsoft YaHei",微软雅黑;line{%*i*%}-height:14px;_line-height:15px;cursor:pointer;word-break:normal}.op-map-subway-stop a{color:#333!important;width:20px;height:116px;padding:8px 3px;_padding:6px 1px;text-decoration:none;display:block}.op-map-subway-stop-tail{display:block;background-position:-62px 2px;width:10px;height:12px}.op-map-subway-stop a.op-map-subway-stop-hover{padding:7px 2px;_padding:5px 0;border:1px solid #389cff}.op-map-subway-stop-num{display:inline-block;width:20px;font-family:arial;padding-bottom:6px;cursor:pointe{%*i*%}r}.op-map-subway-stop-text{display:inline-block;width:18px;text-align:left;margin-left:3px;cursor:pointer}.op-map-subway-showmore,.op-map-subway-showless{border-top:1px solid #ebebeb;cursor:pointer;padding-top:2px;margin-top:12px}.op-map-subway-showmore i,.op-map-subway-showless i{cursor:pointer;_vertical-align:top}.op-map-subway-showmore-inner,.op-map-subway-showless-inner{text-align:center;color:#00c;position:relative;top:3px;_top:4px}.op-map-subway-content{position:relative;-webkit-perspectiv{%*i*%}e:1000px;-moz-perspective:1000px;-o-perspective:1000px;perspective:1000px}.op-map-subway-content-inner{-webkit-transform-style:preserve-3d;-webkit-transition:all .7s linear;-moz-transform-style:preserve-3d;-moz-transition:all .7s linear;-o-transform-style:preserve-3d;-o-transition:all .7s linear;transform-style:preserve-3d;transition:all .7s linear}.op-map-subway-z-index400{z-index:400}.op-map-subway-flip-board{position:absolute;*position:static;width:100%;top:0;left:0;-webkit-backface-visibilit{%*i*%}y:hidden;-moz-backface-visibility:hidden;-o-backface-visibility:hidden;backface-visibility:hidden}.op-map-subway-content-inner-transform{-webkit-transform:rotateY(180deg);-moz-transform:rotateY(180deg);-o-transform:rotateY(180deg);transform:rotateY(180deg)}.op-map-subway-content-back{-webkit-transform:rotateY(180deg);-moz-transform:rotateY(180deg);-o-transform:rotateY(180deg);transform:rotateY(180deg)}.op-map-subway-station-layout{border-spacing:0;border-collapse:collapse;width:100%;table-layout{%*i*%}:fixed}.op-map-subway-station-layout td{padding:0}.op-map-subway-station-layout td.op-map-subway-station-prev,.op-map-subway-station-layout td.op-map-subway-station-next{width:26px;border-top:1px solid #fff;border-bottom:1px solid #fff;cursor:pointer}.op-map-subway-station{position:relative;overflow:hidden;width:551px;margin-left:3px}.op-map-subway-station-inner{position:absolute;top:0;left:0;top:10px}.op-map-subway-station-layout td.op-map-subway-station-toucher-hover{background-color:#f5f5f5}.{%*i*%}op-map-subway-station{visibility:hidden}.op-map-subway-station-toucher{vertical-align:top}.op-map-subway-station-prev div,.op-map-subway-station-next div{width:10px;height:24px;cursor:pointer}.op-map-subway-station-prev div{background-position:-18px -100px;margin-left:6px}.op-map-subway-station-next div{background-position:0 -100px;margin-left:10px}.op-map-subway-station-layout td.op-map-subway-station-prev-disable,.op-map-subway-station-layout td.op-map-subway-station-next-disable{cursor:defaul{%*i*%}t}.op-map-subway-station-prev-disable div{background-position:-18px -134px;cursor:default}.op-map-subway-station-next-disable div{background-position:0 -134px;cursor:default}.op-map-subway-icon{width:12px;height:12px;display:inline-block;background:url(http://www.baidu.com/aladdin/img/map_subway/map_icons.png) no-repeat;_background:url(http://www.baidu.com/aladdin/img/map_subway/map_icons.gif) no-repeat}.op-map-subway-icon-flight{background-position:0 0;margin-left:1px}.op-map-subway-station{pad{%*i*%}ding:10px 0}.op-map-subway-line{height:128px;position:relative}.op-map-subway-line-stop{position:relative;width:26px;height:128px;float:left;_display:inline}.op-map-subway-line-stop-info{width:26px;height:108px;position:relative;left:-3px}.op-map-subway-line-stop-info a{position:relative;display:block;width:26px;height:108px;color:#333!important;text-decoration:none;outline:0}.op-map-subway-line-stop-info-text{position:absolute;display:block;bottom:6px;left:4px;width:18px;line-height:14px;text-a{%*i*%}lign:center;cursor:pointer;font-family:"Microsoft YaHei",微软雅黑}.op-map-subway-line1 .op-map-subway-line-stop-info .op-map-subway-line-stop-info-text{bottom:auto;top:6px}.op-map-subway-line-stop-transfer-info{width:18px;height:56px;position:absolute;bottom:144px;line-height:14px;margin-left:1px;text-align:center;font-family:"Microsoft YaHei",微软雅黑}.op-map-subway-line-stop-transfer-info-text{position:absolute;left:0;bottom:0;width:18px;color:#333;z-index:20}.op-map-subway-line-stop-transfer-info .op{%*i*%}-map-subway-line-stop-transfer-info-name-prefix{white-space:nowrap;position:relative;width:38px;overflow:hidden;display:inline-block;text-overflow:ellipsis;text-align:left}.op-map-subway-line-stop-container{position:relative;z-index:1}.op-map-subway-line-stop-icon{position:relative;width:20px;height:20px;text-align:center;line-height:20px;font-family:arial}.op-map-subway-line-stop-icon-canvas-container{position:absolute;top:0;left:0;width:20px;height:20px;cursor:pointer}.op-map-subway-line-stop-{%*i*%}icon-text{position:absolute;top:0;left:1px;*top:0;*left:0;width:20px;height:20px;font-family:arial;font-size:12px;*font-size:11px;color:#666;-webkit-transform:scale(0.917);-webkit-transform-origin:0 0;-moz-transform:scale(0.917);-moz-transform-origin:left center}.op-map-subway-line-stop-icon-text div{width:20px;height:20px;background-position:-66px -21px;cursor:pointer}.op-map-subway-line-stop-transfer-line-box{position:absolute;top:-10px;width:20px;height:18px}.op-map-subway-line-stop-transfer-{%*i*%}line-box-inner{margin:0 auto}.op-map-subway-line-stop-transfer-line{width:6px;height:18px;float:left;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px}.op-map-subway-line2 .op-map-subway-line-stop-transfer-line-box{top:auto;bottom:-10px}.op-map-subway-line-line{position:absolute;width:100px;height:6px;overflow:hidden}.op-map-subway-line-slash-canvas-container{position:absolute;width:34px}.op-map-subway-line-middle-seperator{position:relative}.op-map-subway-tip{position:absolute;{%*i*%}z-index:999;top:-2000px;left:-2000px;display:none;background:#fff;padding:10px;border:1px solid #ccc;-webkit-box-shadow:2px 2px 2px rgba(0,0,0,0.1);-moz-box-shadow:2px 2px 2px rgba(0,0,0,0.1);-o-box-shadow:2px 2px 2px rgba(0,0,0,0.1);box-shadow:2px 2px 2px rgba(0,0,0,0.1)}.op-map-subway-tip-title{font-size:14px;font-weight:bold}.op-map-subway-tip-stop-name{border-bottom:1px solid}.op-map-subway-tip-stop-name div{display:inline-block;height:20px;line-height:20px;color:#fff;font-size:13px;padding:{%*i*%}0 4px;*display:inline;*zoom:1}.op-map-subway-tip-stop-line{border-spacing:0;padding:0}.op-map-subway-tip-stop-line td{font-size:12px;border-collapse:collapse;line-height:16px;*line-height:12px}.op-map-subway-tip-stop-line td.op-map-subway-tip-td-left{padding-right:20px}.op-map-subway-tip-stop-line td.op-map-subway-tip-td-right{width:110px}.op-map-subway-tip-stop-line td.op-map-subway-tip-td-right div{display:inline-block;*display:inline;*zoom:1}.op-map-subway-icon-start,.op-map-subway-icon-end{w{%*i*%}idth:13px;height:13px;font-size:12px;line-height:13px;*line-height:14px;text-align:center;color:#fff;background-color:#6cf;margin-right:4px;*position:relative;*top:-2px}.op-map-subway-start-time{width:40px}.op-map-subway-arrow{width:0;height:0;font-size:0;line-height:0;display:block;position:absolute;bottom:0;left:30px}.op-map-subway-arrow em,.op-map-subway-arrow ins{width:0;height:0;font-size:0;line-height:0;display:block;position:absolute;border:8px solid #000;border-style:solid dashed dashed {%*i*%}dashed}.op-map-subway-arrow em{border-color:#d8d8d8 transparent transparent transparent}.op-map-subway-arrow ins{border-color:#fff transparent transparent transparent;top:-2px}</style><div class="op-map-subway-content" style="height:{%if $tplData.config.hasCross%}{%136+2+10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+10+2+40%}{%else%}{%110+2+10+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+10+2%}{%/if%}px;" data-citycode="{%$tplData.cityCode|escape%}"> <div class="op-map-subway-content-inner"> {%foreach $tplData.lines[0] as $item%}{%*分叉开始索引*%}{%$tempDataCross1Index=0%}{%$tempDataCross2Index=0%}{%*分叉方向*%}{%$tempDataCrossDirection='right'%}{%*主线站点集合*%}{%$tempDataCross1Stops=$item['stopInfo']%}{%*站点容器宽度buffer*%}{%$tempDataContainerWidthBuffer=14%}{%*站点容器宽度*%}{%$tempDataContainerWidth=count($tempDataCross1Stops)*34-14+$tempDataContainerWidthBuffer%}{%if $tplData.config.hasCross%}{%*辅线站点集合*%}{%$tempDataCross2Stops=$tplData.lines[1][$item@index]['stopInfo']%}{%*若两条分叉线路的第一站站名不相同，则表示分叉向左*%}{%if $tempDataCross1Stops[0]['stopName'] != $tempDataCross2Stops[0]['stopName']%}{%$tempDataCrossDirection='left'%}{%/if%}{%*正向(右)时计算分叉点*%}{%if $tempDataCrossDirection=='right'%}{%foreach $tempDataCross1Stops as $item1%}{%$tempDataCross2StopName=$tempDataCross2Stops[$item1@index]['stopName']%} {%if $item1['stopName'] != $tempDataCross2StopName%}{%$tempDataCross1Index=$item1@index%}{%$tempDataCross2Index=$item1@index%}{%*$tempDataContainerWidth=(count(array_slice($tempDataCross1Stops, 0, $tempDataCross1Index+1))+count(array_slice($tempDataCross2Stops, $tempDataCross2Index+1)))*34-14+$tempDataContainerWidthBuffer*%}{%break%}{%/if%}{%/foreach%}{%/if%}{%*反向(左)时计算分叉点*%}{%if $tempDataCrossDirection=='left'%}{%$tempDataFoundFlag=false%}{%foreach $tempDataCross1Stops as $item1%}{%foreach $tempDataCross2Stops as $item2%} {%if $item1['stopName'] == $item2['stopName']%}{%$tempDataCross1Index=$item1@index%}{%$tempDataCross2Index=$item2@index%}{%$tempDataFoundFlag=true%}{%/if%}{%/foreach%}{%if $tempDataFoundFlag==true%}{%break%}{%/if%}{%/foreach%} {%/if%}{%*站点容器宽度*%}{%if count($tempDataCross2Stops)>count($tempDataCross1Stops)%}{%$tempDataContainerWidth=count($tempDataCross2Stops)*34-14+$tempDataContainerWidthBuffer%}{%/if%}{%*主线交叉路段有无换乘*%}{%foreach $tempDataCross1Stops as $itemInner%}{%if $itemInner@index>$tempDataCross1Index && $itemInner.transfer && count($itemInner.transfer)>0%}{%$tempDataCross1HasTransfer=true%}{%/if%}{%/foreach%}{%*辅线交叉路段有无换乘*%}{%foreach $tempDataCross2Stops as $itemInner%}{%if $itemInner@index>$tempDataCross1Index && $itemInner.transfer && count($itemInner.transfer)>0%}{%$tempDataCross2HasTransfer=true%}{%/if%}{%/foreach%}{%*根据主辅交叉路段有无换乘决定间隔支撑块高度*%}{%*
			{%if $tempDataCross1HasTransfer && $tempDataCross2HasTransfer%}
				{%$tplData.config.middleSeperatorHeight=50%}
			{%else%}
				{%$tplData.config.middleSeperatorHeight=34%}
			{%/if%}
			*%}{%/if%} <div class="op-map-subway-flip-board{%if $item@index==1%} op-map-subway-content-back{%/if%}" style="z-index:{%10-$item@index%};{%if $item@index>0%}*display:none;{%/if%}" data-line-color="{%$item['lineColor']|escape%}" data-zindex-toggle="{%10-(1-$item@index)%}"> <table class="op-map-subway-info"> <tr> {%if $item.busName1||$item.busName2%} <td class="op-map-subway-info-left"{%*{%if $tplData.config.hasCross%} style="padding-top:20px;"{%/if%}*%}>{%$tempDataBusName1FontSize={%fe_fn_bus_font_size_zoom2 str=$item.busName1 zoomMap=$tempDataNumFontSizeZoomMap%}%} <div class="op-map-subway-info-num" style="font-size:{%$tempDataBusName1FontSize%}px;line-height:{%$tempDataBusName1FontSize%}px;height:{%$tempDataBusName1FontSize%}px;">{%$item.busName1|escape%}</div>{%$tempDataBusName2Length=$item.busName2|string_display_len%} <div{%if $tempDataBusName2Length>8%} title="{%$item.busName1|cat:$item.busName2|escape%}"{%/if%} class="op-map-subway-info-tag {%if $item.busName2 && trim($item.busName2)%}op-map-subway-info-tag-{%fe_fn_bus_tag_map tag=$item.busName2%}{%/if%}">{%$item.busName2|limitlen:8|escape%}</div> </td> {%/if%} <td class="op-map-subway-info-right"> <div class="op-map-subway-info-right-container"> <table class="op-map-subway-info-start-end"{%if $tplData.config.hasCross%} style="height:44px;"{%/if%}> <tr> {%if $tplData.config.hasCross%} <td class="op-map-subway-info-start">{%if $tempDataCrossDirection=='left'%}<div style="font-size:16px;line-height:16px;margin-bottom:10px;">{%$item.startName|escape%}</div><div style="font-size:16px;line-height:16px;">{%$tplData.lines[1][$item@index].startName|escape%}</div>{%else%}<div style="font-size:20px;line-height:42px;">{%$item.startName|escape%}</div>{%/if%}</td> <td class="op-map-subway-info-direction op-map-subway-info-cross-direction-{%$tempDataCrossDirection%}">&nbsp;</td> <td class="op-map-subway-info-end">{%if $tempDataCrossDirection=='right'%}<div style="font-size:16px;line-height:16px;margin-bottom:10px;">{%$item.endName|escape%}</div><div style="font-size:16px;line-height:16px;">{%$tplData.lines[1][$item@index].endName|escape%}</div>{%else%}<div style="font-size:20px;line-height:42px;">{%$item.endName|escape%}</div>{%/if%}</td> {%else%} {%$tempDataStartEndFontSize={%fe_fn_bus_font_size_zoom str=$item.startName|cat:$item.endName zoomMap=$tempDataStartEndFontSizeZoomMap%}%} <td class="op-map-subway-info-start" style="font-size:{%$tempDataStartEndFontSize%}px;line-height:{%if $tempDataStartEndFontSize<20%}20{%else%}{%$tempDataStartEndFontSize%}{%/if%}px;">{%$item.startName|escape%}</td> <td class="op-map-subway-info-direction">&nbsp;</td> <td class="op-map-subway-info-end" style="font-size:{%$tempDataStartEndFontSize%}px;line-height:{%if $tempDataStartEndFontSize<20%}20{%else%}{%$tempDataStartEndFontSize%}{%/if%}px;">{%$item.endName|escape%}</td> {%/if%} </tr> </table> <div class="op-map-subway-info-info"> {%if $tplData.config.hasCross%} <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$item.startTime|escape%}</span> <span class="op-map-subway-info-endtime">末车：{%$item.endTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$tplData.lines[1][$item@index].startTime|escape%}</span> <span class="op-map-subway-info-endtime">末车：{%$tplData.lines[1][$item@index].endTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-price">票价：{%if $item.priceNum<$tplData.lines[1][$item@index].priceNum%}{%$tplData.lines[1][$item@index].price%}{%else%}{%$item.price|escape%}{%/if%}</span> </div> {%else%} <div class="c-clearfix"> <span class="op-map-subway-info-starttime">首车：{%$item.startTime|escape%}</span> </div> <div class="c-clearfix"> <span class="op-map-subway-info-endtime">末车：{%$item.endTime|escape%}</span> <span class="op-map-subway-info-price">票价：{%$item.price|escape%}</span> </div> {%/if%} </div> {%if $item|count > 1%} <div class="op-map-subway-info-switcher-border"></div><div class="op-map-subway-info-switcher OP_LOG_BTN" data-click="{fm:'beha'}">返程</div> {%/if%} <a href="{%$item.lineUrl%}" target="_blank" class="op-map-subway-info-link">在地图上显示路线</a> </div> </td> </tr> </table> <div class="op-map-subway-station-container"> <table class="op-map-subway-station-layout"> <tr> <td class="op-map-subway-station-toucher op-map-subway-station-prev op-map-subway-station-prev-disable" data-direction="1"{%if count($tempDataCross1Stops)>16 || ($tplData.config.hasCross && count($tempDataCross2Stops)>16)%}{%else%} style="visibility:hidden;"{%/if%}> <div style="margin-top:{%if $tplData.config.hasCross%}{%10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+10-24/2%}{%else%}{%10+$tplData.config.middleSeperatorHeight+10-24/2%}{%/if%}px;"></div> </td> <style></style> <td> <div class="op-map-subway-station" style="height:{%if $tplData.config.hasCross%}{%$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight+40%}{%else%}{%$tplData.config.middleSeperatorHeight+$tplData.config.lineBoxHeight%}{%/if%}px;"> <div class="op-map-subway-station-inner" style="width:{%$tempDataContainerWidth%}px;left:0;padding:0 3px;"> {%if $tplData.config.hasCross%} <div class="op-map-subway-line op-map-subway-line2"> <div class="op-map-subway-line-stop-container c-clearfix"> {%$tempDataCross1MarginLeft=0%} {%$tempDataCross2MarginLeft=0%} {%if $tempDataCrossDirection=='right'%} {%*删掉辅线重叠站点*%} {%$tempDataCross2Stops=array_slice($tempDataCross2Stops, $tempDataCross2Index)%} {%$tempDataCross2MarginLeft=$tempDataCross1Index*34%} {%$tempDataCross2BlockLeft=$tempDataCross2MarginLeft-10-14%} {%$tempDataCross2LineWidth=(count($tempDataCross2Stops)-1)*34%} {%else%} {%*删掉辅线重叠站点*%}{%*var_dump($tempDataCross2Index)*%} {%$tempDataCross2Stops=array_slice($tempDataCross2Stops, 0, $tempDataCross2Index)%} {%if $tempDataCross2Index<=$tempDataCross1Index%} {%$tempDataCross2MarginLeft=($tempDataCross1Index-$tempDataCross2Index)*34%}{%else%} {%$tempDataCross2MarginLeft=0%} {%$tempDataCross1MarginLeft=($tempDataCross2Index-$tempDataCross1Index)*34%} {%/if%} {%$tempDataCross2BlockLeft=$tempDataCross2MarginLeft+(count($tempDataCross2Stops)-1)*34+10%} {%$tempDataCross2LineWidth=(count($tempDataCross2Stops)-1)*34%} {%/if%} {%foreach $tempDataCross2Stops as $itemInner%} <div class="op-map-subway-line-stop" style="{%if $itemInner@first%}margin-left:{%$tempDataCross2MarginLeft%}px;{%/if%}margin-right:{%if $itemInner@last%}0{%else%}8{%/if%}px;"> {%$tempDataHasTranfer=false%} {%if $itemInner.transfer && count($itemInner.transfer)>0%} {%$tempDataHasTranfer=true%} {%/if%} {%if $tempDataHasTranfer%} <div class="op-map-subway-line-stop-transfer-info" style="top:150px;height:auto;width:auto;white-space:nowrap;"> <div class="op-map-subway-line-stop-transfer-info-text"></div> </div> <div class="op-map-subway-line-stop-transfer-line-box"> <div class="op-map-subway-line-stop-transfer-line-box-inner c-clearfix" style="width:{%count($itemInner.transfer)*$tplData.config.transferLineWidth%}px;"> {%foreach $itemInner.transfer as $itemTransfer%} <div class="op-map-subway-line-stop-transfer-line" data-name="{%$itemTransfer.name|escape%}" style="background-color:{%$itemTransfer.lineColor|escape%}"></div> {%/foreach%} </div> </div> {%/if%} <div class="op-map-subway-line-stop-info"> <a href="{%$itemInner.stopUrl%}" target="_blank" hidefocus="true"{%if $itemInner.stopName|string_display_len>10%} title="{%$itemInner.stopName|escape%}"{%/if%}> <span class="op-map-subway-line-stop-info-text">{%if strpos($itemInner.stopName, '航站楼')!=false%}<span class="op-map-subway-icon op-map-subway-icon-flight"></span>{%/if%}{%str_replace('...','…',$itemInner.stopName|limitlen:12)|escape%}</span> </a> </div> <div class="op-map-subway-line-stop-icon"{%if $tempDataHasTranfer%} data-transfer="true"{%/if%}> <div class="op-map-subway-line-stop-icon-canvas-container"></div> <div class="op-map-subway-line-stop-icon-text">{%if $tempDataHasTranfer%}<div data-stop="{%$itemInner.stopName|escape%}" data-uid="{%$itemInner.uid|escape%}"></div>{%else%}{%$itemInner.stopNo|escape%}{%/if%}</div> </div> </div> {%/foreach%} </div> <div class="op-map-subway-line-line" style="bottom:7px;left:{%$tempDataCross2MarginLeft+10%}px;width:{%$tempDataCross2LineWidth%}px;background-color:{%$item['lineColor']|escape%}"></div> <div class="op-map-subway-line-slash-canvas-container" data-direction="{%$tempDataCrossDirection%}" style="top:{%$tplData.config.lineBoxHeight-10%}px;left:{%$tempDataCross2BlockLeft%}px;height:{%10+10+$tplData.config.middleSeperatorHeight%}px;"></div> </div> {%/if%} <div class="op-map-subway-line-middle-seperator" style="height:{%$tplData.config.middleSeperatorHeight%}px;"></div> <div class="op-map-subway-line op-map-subway-line1"> <div class="op-map-subway-line-stop-container c-clearfix"> {%foreach $tempDataCross1Stops as $itemInner%} <div class="op-map-subway-line-stop" style="{%if $itemInner@first%}margin-left:{%$tempDataCross1MarginLeft%}px;{%/if%}margin-right:{%if $itemInner@last%}0{%else%}8{%/if%}px;"> {%$tempDataHasTranfer=false%} {%if $itemInner.transfer && count($itemInner.transfer)>0%} {%$tempDataHasTranfer=true%} {%/if%} {%if $tempDataHasTranfer%} <div class="op-map-subway-line-stop-transfer-info" {%if $tplData.config.hasCross%}{%if ($tempDataCrossDirection=='right'&&$itemInner@index>=$tempDataCross1Index) || ($tempDataCrossDirection=='left'&&$itemInner@index<=$tempDataCross1Index)%}style="width:auto;height:auto;white-space:nowrap;"{%/if%}{%/if%}> <div class="op-map-subway-line-stop-transfer-info-text"></div> </div> <div class="op-map-subway-line-stop-transfer-line-box"> <div class="op-map-subway-line-stop-transfer-line-box-inner c-clearfix" style="width:{%count($itemInner.transfer)*$tplData.config.transferLineWidth%}px;"> {%foreach $itemInner.transfer as $itemTransfer%} <div class="op-map-subway-line-stop-transfer-line" data-name="{%$itemTransfer.name|escape%}" style="background-color:{%$itemTransfer.lineColor|escape%}"></div> {%/foreach%} </div> </div> {%/if%} <div class="op-map-subway-line-stop-icon"{%if $tempDataHasTranfer%} data-transfer="true"{%/if%}> <div class="op-map-subway-line-stop-icon-canvas-container"></div> <div class="op-map-subway-line-stop-icon-text">{%if $tempDataHasTranfer%}<div data-stop="{%$itemInner.stopName|escape%}" data-uid="{%$itemInner.uid|escape%}"></div>{%else%}{%$itemInner.stopNo|escape%}{%/if%}</div> </div> <div class="op-map-subway-line-stop-info"> <a href="{%$itemInner.stopUrl%}" target="_blank" hidefocus="true"{%if $itemInner.stopName|string_display_len>10%} title="{%$itemInner.stopName|escape%}"{%/if%}> <span class="op-map-subway-line-stop-info-text">{%str_replace('...','…',$itemInner.stopName|limitlen:12)|escape%}{%if preg_match('/(机场|航站楼)$/', $itemInner.stopName) > 0%}<span class="op-map-subway-icon op-map-subway-icon-flight"></span>{%/if%}</span> </a> </div> </div> {%/foreach%} </div> <div class="op-map-subway-line-line" style="top:7px;left:{%$tempDataCross1MarginLeft+10%}px;width:{%(count($tempDataCross1Stops)-1)*34%}px;background-color:{%$item['lineColor']|escape%}"></div> </div>{%if $tplData.config.hasCross%} <div style="height:40px;">&nbsp;</div> {%/if%} </div> </div> </td> <td class="op-map-subway-station-toucher op-map-subway-station-next" data-direction="-1"{%if count($tempDataCross1Stops)>16 || ($tplData.config.hasCross && count($tempDataCross2Stops)>16)%}{%else%} style="visibility:hidden;"{%/if%}> <div style="margin-top:{%if $tplData.config.hasCross%}{%10+$tplData.config.lineBoxHeight+$tplData.config.middleSeperatorHeight+10-24/2%}{%else%}{%10+$tplData.config.middleSeperatorHeight+10-24/2%}{%/if%}px;"></div> </td> </tr> </table><style></style> </div> </div> {%/foreach%} </div></div><script>A.setup({middleSeperatorHeight:parseInt('{%$tplData.config.middleSeperatorHeight%}')});</script><script data-merge>A.setup(function(){var canvasable = !!(document.createElement('canvas').getContext);var flipTimer1 = null, flipTimer2 = null, tipTimer = null, pageChange = false;var _this = this;var container = _this.find('.op-map-subway-content')[0];function subByte(str, len, tail){ var a = [], s = str.split('');tail = tail || '…'; for(var i = 0, l = s.length; i < l; i++){if(s[i].charCodeAt(0) > 255){a.push("*");}a.push(s[i]);}if(len && len > 0 && a.length > len){ s = a.join(""{%*i*%}).substring(0, len - 1).replace(/\*/g,'') + tail;}else{return str;}return s;}; var $container = $(container);var $body = $(document.body);var cityCode = $container.attr('data-citycode');$flips = $container.find('.op-map-subway-flip-board');$flips.each(function(i, n){var $n = $(n);var lineColor = $n.attr('data-line-color');var $transfers = $n.find('.op-map-subway-line-stop-transfer-line-box');$transfers.each(function(j, m){var $m = $(m);var $transLine = $m.find('.op-map-subway-line-stop-transfer-{%*i*%}line');var $transLineInfo = $m.prev('.op-map-subway-line-stop-transfer-info');var names = '';var originName = '';var mutiNames = '';if($transLine.length == 1){originName = $transLine.eq(0).attr('data-name').replace(/(\u5730\u94c1|\u8f68\u9053\u4ea4\u901a)/,'');names = subByte(originName,6);}else if($transLine.length > 1){ var arr = [];var hao = false;$transLine.each(function(k, o){var $o = $(o);mutiNames += (k == 0 ? '' : '\n') + $o.attr('data-name');var name = $o.attr('data-name').replace(/\u57{%*i*%}30\u94c1/,'');if(name.indexOf('\u53f7')){hao = true;}name = name.replace(/(\u53f7)?\u7ebf/g, '');name = name.replace(/4\u53f7\u7ebf\u5927\u5174\u7ebf/, '4');arr.push(name);});names = arr.join('/').replace(/\/$/, '');names = '<span class="op-map-subway-line-stop-transfer-info-name-prefix">' + names + '</span>' + (hao ? '号' : '') + '线';}if(names.indexOf('…') > -1){$transLineInfo.attr('title', originName);}if(mutiNames){$transLineInfo.attr('title', mutiNames);}$transLineInfo.find('.op-map-subway-li{%*i*%}ne-stop-transfer-info-text').html(names);});if(i === 0){}var $station = $n.find('.op-map-subway-station');var stationWidth = $station.width();var $stationInner = $n.find('.op-map-subway-station-inner');var stationInnerWidth = $stationInner.width();var stationInner = $stationInner.get(0);var $toucher = $n.find('.op-map-subway-station-toucher');$toucher.bind('touchstart', function(){var $t = $(this);if(!/disable/.test($t.get(0).className)){$t.addClass('op-map-subway-station-toucher-hover');}}).bin{%*i*%}d('touchend' ,function(){$(this).removeClass('op-map-subway-station-toucher-hover');});function getLeave(direction){return (direction == '-1' ? stationInnerWidth - Math.abs(parseInt(stationInner.style.left, 10)) - stationWidth : Math.abs(parseInt(stationInner.style.left, 10)));}function getMovePos(direction, leave){return (direction == '-1' ? '-=' : '+=') + (leave >= stationWidth ? stationWidth : leave);}function getMoveEnableClass(direction){return 'op-map-subway-station-'+ (direction == '-1' ?{%*i*%} 'prev' : 'next') +'-disable';}function getMoveDisableClass(direction){return 'op-map-subway-station-'+ (direction == '-1' ? 'next' : 'prev') +'-disable';}$toucher.click(function(){var $t = $(this);if(/disable/.test(this.className)){return;}if($t.data('animating')){return;}var direction = $t.attr('data-direction');var $tt = $toucher.eq(direction == '-1' ? 0 : 1);var leave = getLeave(direction);if(leave > 0){$t.data('animating', true);$stationInner.animate({'left': getMovePos(direction, leave)},6{%*i*%}00, function(){if(getLeave(direction) == 0){$t.addClass(getMoveDisableClass(direction)); $t.removeClass('op-map-subway-station-toucher-hover');}$tt.removeClass(getMoveEnableClass(direction)); $t.removeData('animating');});}});var $icons = $n.find('.op-map-subway-line-stop-icon');var $slashCanvasContainer = $n.find('.op-map-subway-line-slash-canvas-container');function drawCircle(canvas){var ctx = canvas.getContext('2d');ctx.fillStyle = lineColor;ctx.beginPath(); ctx.arc(10, 10, 10, 0, Math.PI*2,{%*i*%} true);ctx.closePath();ctx.fill(); ctx.fillStyle = '#fff';ctx.beginPath(); ctx.arc(10, 10, 9, 0, Math.PI*2, true);ctx.closePath();ctx.fill(); }function drawSlash(canvas, direction){var ctx = canvas.getContext('2d');ctx.strokeStyle = lineColor;ctx.lineWidth = 6;ctx.beginPath();if(direction=='right'){ctx.moveTo(0, canvas.height);ctx.lineTo(34, 0);}else{ ctx.moveTo(0, 0);ctx.lineTo(34, canvas.height);}ctx.closePath();ctx.stroke();}var transferTipUrl = 'http://map.baidu.com/?qt=inf&newmap=1&it=3&ie={%*i*%}utf-8&f=[1,12,13]&m=sbw';var $last = null;function hideTip($obj, flag){var $tip = $obj.data('tip');if($tip && $tip.length === 1){if(flag){if(tipTimer){clearTimeout(tipTimer);tipTimer = null;$tip.hide();}}else{tipTimer = setTimeout(function(){$tip.hide();clearTimeout(tipTimer);tipTimer = null;},200);}}}function bindTransferTipEvent($o){$o.mouseenter(function(e){$o.data('status', 'in');if($last){if($last.get(0) === $o.get(0)){if(tipTimer){clearTimeout(tipTimer);tipTimer = null;return; }}else{hideT{%*i*%}ip($last, true);}}$last = $o;var $tip = $o.data('tip');if($tip && $tip.length === 1){if($o.data('status') === 'in'){var h = $tip.outerHeight();var offset = $o.offset(); var top = offset.top-h-10;var left = offset.left-30;$tip.css({top: top, left: left}).show();}return;}var stop = $o.attr('data-stop'),uid = $o.attr('data-uid'),url = transferTipUrl+'&uid='+encodeURIComponent(uid)+'&c='+cityCode+'&ccode='+cityCode+'&t='+(+new Date());$.ajax({url:url+'&cb=subway',dataType:'jsonp',success:function(da{%*i*%}ta){ if(pageChange){return;}if(data && data.content && data.content.ext && data.content.ext.line_info && data.content.ext.line_info.length){var info = data.content.ext.line_info;var temp = '';var filter = {};for(var i = 0, item; item = info[i]; i++){var abb = encodeURIComponent(item.abb);if(!filter[abb]){filter[abb] = [];}filter[abb].push(item);}$tip = $('<div class="op-map-subway-tip"></div>');var tipHtml = '<div class="op-map-subway-tip-title">'+ stop +'</div>';temp = '';tipHtml += '<table cla{%*i*%}ss="op-map-subway-tip-stop-line">';for(var o in filter){if(filter.hasOwnProperty(o)){var transferLines = filter[o];if(transferLines.length > 2){transferLines = transferLines.slice(0, 2);}for(var i = 0, item; item = transferLines[i]; i++){var color = item.clr.replace(/^0x/, '#');var mt = 0;if(i === 0){tipHtml += ''+'<tr>'+'<td colspan="2">'+'<div class="op-map-subway-tip-stop-name" style="border-color:'+ color +';margin-top:4px;">'+'<div style="background-color:'+color+'">'+ (item.line_name||'') {%*i*%}+'</div>'+'</div>'+'</td>'+'</tr>'; }tipHtml += ''+'<tr>'+'<td class="op-map-subway-tip-td-left">'+ (item.terminals||'') +'方向</td>'+'<td class="op-map-subway-tip-td-right">'+'<div class="op-map-subway-icon-start">始</div>'+'<div class="op-map-subway-start-time">'+ (item.first_time||'-- --') +'</div>'+'<div class="op-map-subway-icon-end">末</div>'+'<div>'+ (item.last_time||'-- --') +'</div>'+'</td>'+'</tr>';}}}tipHtml += '</table>';tipHtml += '<div class="op-map-subway-arrow"><em></em><ins></ins></d{%*i*%}iv>';$tip.html(tipHtml).appendTo($body);$o.data('tip', $tip);if($o.data('status') === 'in'){var h = $tip.outerHeight();var offset = $o.offset(); var top = offset.top-h-10;var left = offset.left-30;$tip.css({top: top, left: left}).show();}$tip.mouseleave(function(e){if($o && $o.length === 1 && $o.get(0) !== e.relatedTarget && !$.contains($o.get(0), e.relatedTarget)){hideTip($o);}});}},jsonpCallback:'subway'});}).mouseleave(function(e){$o.data('status', 'out');var $tip = $o.data('tip');if($tip && {%*i*%}$tip.length === 1 && $tip.get(0) !== e.relatedTarget && !$.contains($tip.get(0), e.relatedTarget)){hideTip($o);}}); }var isie = /msie (\d+\.\d+)/i.test(navigator.userAgent) ? (document.documentMode || + RegExp['\x241']) : undefined;if(isie){ A.use('canvas', function(){$icons.each(function(i, n){var $n = $(n);var canvas = document.createElement('canvas');canvas.width = 20;canvas.height = 20; $n.find(".op-map-subway-line-stop-icon-canvas-container").append(canvas);A.ui.canvas.init(canvas);drawCirc{%*i*%}le(canvas);var hasTransfer = $n.attr('data-transfer');if(hasTransfer){bindTransferTipEvent($n.find(".op-map-subway-line-stop-icon-text>div"));}});$slashCanvasContainer.each(function(i, n){var $n = $(n);var slashCanvas = document.createElement('canvas');slashCanvas.width = 34;slashCanvas.height = 10+10+_this.data.middleSeperatorHeight;$n.append(slashCanvas);A.ui.canvas.init(slashCanvas);var direction = $n.attr('data-direction');drawSlash(slashCanvas, direction);});$station.css('visibility', 'visi{%*i*%}ble');});}else{$icons.each(function(i, n){var $n = $(n);var canvas = document.createElement('canvas');canvas.width = 20;canvas.height = 20; $n.find('.op-map-subway-line-stop-icon-canvas-container').append(canvas);drawCircle(canvas);var hasTransfer = $n.attr('data-transfer');if(hasTransfer){bindTransferTipEvent($n.find(".op-map-subway-line-stop-icon-text>div"));}});$slashCanvasContainer.each(function(i, n){var $n = $(n);var slashCanvas = document.createElement('canvas');slashCanvas.width = 34;sla{%*i*%}shCanvas.height = 10+10+_this.data.middleSeperatorHeight;$n.append(slashCanvas);var direction = $n.attr('data-direction');drawSlash(slashCanvas, direction);});$station.css('visibility', 'visible');}var $switcherBorder = $n.find('.op-map-subway-info-switcher-border');var $switcher = $n.find('.op-map-subway-info-switcher');$switcher.click(function(){$n.parent().toggleClass('op-map-subway-content-inner-transform');flipTimer1 =setTimeout(function(){$flips.each(function(l,f){var $f = $(this);var zInd{%*i*%}exCur = $f.css('z-index');var zIndexToggle = $f.attr('data-zindex-toggle');$f.css('z-index', zIndexToggle).attr('data-zindex-toggle', zIndexCur);});clearTimeout(flipTimer1);},700);$container.addClass('op-map-subway-z-index400');flipTimer2 = setTimeout(function(){$container.removeClass('op-map-subway-z-index400');},700);});});this.dispose = function(){clearTimeout(flipTimer1);clearTimeout(flipTimer2);clearTimeout(tipTimer);pageChange = true;};});</script>{%/block%}